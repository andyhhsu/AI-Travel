<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—…éŠè¡Œç¨‹è¦åŠƒå¸« v14.6 (Final Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœˆï¸</text></svg>">
    <style>
        :root {
            --primary-color: #0891b2; /* Teal-600 */
            --primary-color-hover: #06b6d4; /* Cyan-500 */
            --secondary-bg: #f0f9ff; /* Sky-50 */
            --danger-color: #dc2626; /* Red-600 */
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--secondary-bg); 
            color: #334155; /* Slate-700 */
        }
        .form-input:focus, .flatpickr-input:focus { 
            --tw-ring-color: var(--primary-color-hover);
            border-color: var(--primary-color-hover);
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        .form-input.invalid {
            border-color: var(--danger-color);
            --tw-ring-color: var(--danger-color);
        }
        .form-input.invalid:focus {
             box-shadow: 0 0 0 2px var(--danger-color);
        }
        .main-title {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-color-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- çµæœå€åŸŸæ¨£å¼ --- */
        #result-container h1 { font-size: 2.25rem; font-weight: bold; margin-bottom: 1rem; color: #1e293b; }
        #result-container h2 { font-size: 1.75rem; font-weight: bold; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; margin-top: 3rem; margin-bottom: 1.5rem; color: var(--primary-color); clear: both; }
        #result-text h3, #result-visual h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; color: #334155; padding-left: 0.5rem; border-left: 4px solid var(--primary-color-hover); }

        .info-card {
            background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            overflow: hidden; margin-bottom: 1.5rem; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; position: relative;
            height: 100%; /* Ensure equal height in grid */
        }
        .info-card:hover, .info-card.highlighted {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-color: var(--primary-color);
        }
        .info-card-image-link { display: block; position: relative; }
        .info-card-image-container { width: 100%; height: 200px; background-color: #e0f2fe; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .info-card-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease;}
        .info-card:hover .info-card-image { transform: scale(1.05); }
        .info-card-image-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 2rem 1rem 0.75rem; color: white; font-weight: bold; font-size: 1.2rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .info-card-content { padding: 1rem 1.25rem; flex-grow: 1; padding-bottom: 4rem; display: flex; flex-direction: column;}
        .info-card-details { display: flex; flex-direction: column; gap: 0.75rem; color: #475569; font-size: 0.95rem; }
        .info-card-details .detail-item { display: flex; align-items: flex-start; gap: 0.75rem; word-break: break-word; line-height: 1.5; }
        .info-card-details .detail-icon { width: 18px; height: 18px; flex-shrink: 0; color: var(--primary-color); margin-top: 3px;}
        .info-card-details a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .info-card-details a:hover { text-decoration: underline; }
        
        .swap-button {
            position: absolute; bottom: 1rem; right: 1.25rem; background-color: var(--secondary-bg); color: var(--primary-color); border: 1px solid var(--primary-color);
            border-radius: 9999px; padding: 0.4rem 1rem; font-size: 0.875rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 0.25rem;
        }
        .swap-button:hover { background-color: var(--primary-color); color: white; }
        .swap-button.loading { cursor: not-allowed; background-color: #e2e8f0; color: #94a3b8; border-color: #cbd5e1; }
        
        .day-summary-card { background-color: #f0f9ff; border: 1px solid #bae6fd; border-left-width: 5px; border-left-color: var(--primary-color); padding: 1rem 1.5rem; margin-bottom: 2rem; border-radius: 0.5rem; }

        #map-container { width: 100%; height: 60vh; border-radius: 0.75rem; overflow: hidden; background-color: #e2e8f0; position: sticky; top: 20px; }
        .day-toggle-btn { transition: all 0.2s ease-in-out; }
        .day-toggle-btn-active { background-color: var(--primary-color) !important; color: white !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .map-leg-detail-link { display: block; text-decoration: none; margin-bottom: 0.5rem;}
        .map-leg-detail { background-color: #ffffff; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; transition: background-color 0.2s; cursor: pointer; display: flex; align-items: center; gap: 1rem; }
        .map-leg-detail-link:hover .map-leg-detail { background-color: #f0f9ff; border-color: #bae6fd; }
        
        #suggested-tags {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .info-card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
            body { background-color: white; }
        }
    </style>
    <!-- Google Maps API (æ‚¨çš„åœ°åœ– Key å·²è‡ªå‹•å¡«å…¥) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY&callback=initMap&libraries=marker,routes,geocoding,places"></script>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-10 no-print">
            <h1 class="text-4xl sm:text-5xl font-bold main-title mb-3">AI æ—…éŠè¡Œç¨‹è¦åŠƒå¸«</h1>
            <p class="text-lg text-slate-500">è¼¸å…¥æ‚¨çš„æ—…éŠéˆæ„Ÿï¼Œå³åˆ»ç”Ÿæˆå°ˆæ¥­ç´šè¦–è¦ºåŒ–è¡Œç¨‹èˆ‡åœ°åœ–è·¯ç·š</p>
        </div>
        
        <div id="form-validation-message" class="hidden max-w-4xl mx-auto mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-center no-print"></div>

        <div id="input-form" class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl no-print">
            <!-- API Key Input Section -->
            <div class="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg relative">
                <label for="api-key-input" class="block text-md font-medium text-slate-700 mb-2">ğŸ”‘ Google Gemini API Key <span class="text-xs text-slate-500 font-normal">(å¿…å¡«ï¼Œè«‹å‹¿å¡«å…¥åœ°åœ– Key)</span></label>
                <div class="flex gap-2">
                    <input type="password" id="api-key-input" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="è«‹è¼¸å…¥å¾ AI Studio ç”³è«‹çš„ Key..." value="">
                    <button id="clear-key-btn" class="whitespace-nowrap bg-slate-200 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors" title="æ¸…é™¤æš«å­˜çš„é‡‘é‘°">æ¸…é™¤</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">è«‹è‡³ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-cyan-600 hover:underline font-bold">Google AI Studio</a> å…è²»ç”³è«‹ã€‚</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <div>
                        <label for="destination" class="block text-md font-medium text-slate-700 mb-2">ğŸŒ ç›®çš„åœ°</label>
                        <input type="text" id="destination" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬äº¬éƒ½ã€ç‘å£«å°‘å¥³å³°" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="days" class="block text-md font-medium text-slate-700 mb-2">â³ ç¸½å¤©æ•¸</label>
                            <input type="number" id="days" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="ä¾‹å¦‚ï¼š5" min="1" required>
                        </div>
                        <div>
                            <label for="date-picker" class="block text-md font-medium text-slate-700 mb-2">ğŸ—“ï¸ å‡ºç™¼æ—¥æœŸ</label>
                            <input type="text" id="date-picker" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white" placeholder="é¸æ“‡å‡ºç™¼æ—¥æœŸ" required>
                        </div>
                    </div>
                    <div>
                        <label for="traveler-type" class="block text-md font-medium text-slate-700 mb-2">âœˆï¸ æ—…è¡Œè€…é¡å‹</label>
                        <select id="traveler-type" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                            <option>æƒ…ä¾¶èœœæœˆ</option><option>è¦ªå­å®¶åº­</option><option>ç¨è‡ªèƒŒåŒ…æ¢éšª</option><option>ä¸‰äº”å¥½å‹è¼•æ—…è¡Œ</option><option>é€€ä¼‘æ¨‚æ´»æ—</option><option>å•†å‹™å·®æ—…</option>
                        </select>
                    </div>
                     <div>
                        <label for="transport" class="block text-md font-medium text-slate-700 mb-2">ğŸš‡ ä¸»è¦äº¤é€šæ–¹å¼</label>
                        <select id="transport" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                            <option value="æ··åˆ(å¤§çœ¾é‹è¼¸ç‚ºä¸»)">æ··åˆ(å¤§çœ¾é‹è¼¸ç‚ºä¸»)</option>
                            <option value="ç§Ÿè»Šè‡ªé§•">ç§Ÿè»Šè‡ªé§•</option>
                        </select>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="space-y-6">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pacing" class="block text-md font-medium text-slate-700 mb-2">ğŸƒâ€â™‚ï¸ æ—…è¡Œæ­¥èª¿</label>
                            <select id="pacing" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="æ¨™æº–é©ä¸­">æ¨™æº–é©ä¸­ (é è¨­)</option>
                                <option value="æ‚ é–’æ”¾é¬†">æ‚ é–’æ”¾é¬†</option>
                                <option value="ç·Šæ¹Šå……å¯¦">ç·Šæ¹Šå……å¯¦</option>
                            </select>
                        </div>
                        <div>
                            <label for="budget" class="block text-md font-medium text-slate-700 mb-2">ğŸ’° é ç®—ç­‰ç´š</label>
                            <select id="budget" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="å¹³è¡¡èˆ’é©">å¹³è¡¡èˆ’é© (é è¨­)</option>
                                <option value="ç¶“æ¿Ÿå¯¦æƒ ">ç¶“æ¿Ÿå¯¦æƒ </option>
                                <option value="å¥¢è¯äº«å—">å¥¢è¯äº«å—</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-md font-medium text-slate-700">ğŸ¨ ä¸»è¦èˆˆè¶£åå¥½ (é¸å¡«)</label>
                        <div id="interest-tags-container" class="flex flex-wrap gap-2 p-3 border border-slate-300 rounded-lg bg-slate-50 mt-2 min-h-[50px] items-center flex-grow">
                            <input type="text" id="interest-input" class="flex-grow bg-transparent focus:outline-none" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter æ–°å¢...">
                        </div>
                        <div id="suggested-tags" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="generate-btn" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center justify-center mx-auto gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L11.8 9.2a1.21 1.21 0 0 0 0 1.72l5.8 5.8a1.21 1.21 0 0 0 1.72 0l6.84-6.84a1.21 1.21 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-2"/><path d="M11 11 8 8"/><path d="M15 15l3 3"/><path d="m5 21 3-3"/></svg>
                    <span>ç”Ÿæˆéˆæ„Ÿè¡Œç¨‹</span>
                </button>
            </div>
        </div>


        <div id="loader" class="hidden text-center my-10 no-print">
            <svg class="animate-spin h-12 w-12 text-cyan-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-slate-600 font-medium">AI æ­£åœ¨æ®å‹•é­”æ³•æ£’ï¼Œç‚ºæ‚¨å®¢è£½åŒ–å°ˆå±¬è¡Œç¨‹...</p>
            <p id="travel-tip" class="mt-3 text-sm text-slate-500 h-5"></p>
        </div>
        
        <div id="error-message" class="hidden text-center my-10 max-w-2xl mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg no-print"></div>

        <div id="result-wrapper" class="hidden mt-10 max-w-7xl mx-auto">
             <div class="flex justify-between items-center mb-6 flex-wrap gap-4 no-print">
                  <div class="border-b border-slate-200"><nav class="-mb-px flex space-x-2 sm:space-x-6" aria-label="Tabs">
                        <button id="tab-visual" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">âœ¨ è¦–è¦ºåŒ–è¡Œç¨‹</button>
                        <button id="tab-text" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">ğŸ“„ ç´”æ–‡å­—ç‰ˆ</button>
                        <button id="tab-map" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">ğŸ“ åœ°åœ–æ¨¡å¼</button>
                  </nav></div>
                  <div class="flex items-center gap-2">
                        <button id="copy-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">è¤‡è£½æ–‡å­—</button>
                        <button id="export-pdf-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">åŒ¯å‡º PDF</button>
                        <button id="reset-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">é‡æ–°è¦åŠƒ</button>
                  </div>
             </div>
             <div id="result-container" class="bg-white p-4 sm:p-6 md:p-10 rounded-2xl shadow-xl">
                  <div id="result-visual"></div>
                  <div id="result-text" class="hidden prose max-w-none p-4"></div>
                  <div id="result-map" class="hidden">
                        <div id="day-toggles-container" class="flex flex-wrap gap-2 mb-4 no-print"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div class="lg:col-span-8 relative">
                                  <div id="map-container"></div>
                            </div>
                            <div class="lg:col-span-4 max-h-[60vh] overflow-y-auto pr-2">
                                  <div id="map-details-container" class="space-y-3"></div>
                            </div>
                        </div>
                  </div>
             </div>
        </div>
    </div>

    <script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let map;
    let placesService;
    let directionsService;
    let directionsRenderer;
    let dailyLocations = []; 
    let markers = []; 
    let renderers = []; 
    let travelTipsInterval;

    // æ­¤ç‚ºä½¿ç”¨è€…æä¾›çš„åœ°åœ–å°ˆç”¨ Key
    const MAPS_API_KEY = "AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY";

    // Global handler for Google Maps authentication failures
    window.gm_authFailure = function() {
        const mapContainer = document.getElementById("map-container");
        if (mapContainer) {
            mapContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-slate-100 text-slate-500 p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h3 class="text-lg font-bold text-slate-700 mb-2">åœ°åœ–è¼‰å…¥å¤±æ•—</h3>
                    <p class="mb-2">åœ°åœ– API è«‹æ±‚è¢«æ‹’çµ• (403)ã€‚</p>
                    <p class="text-sm">é€™é€šå¸¸æ˜¯å› ç‚ºæ‚¨çš„ API Key å°šæœªåœ¨ Google Cloud Console è¨­å®šç¶²åŸŸé™åˆ¶ï¼Œæˆ–è€…ç¶²åŸŸä¸ç¬¦ã€‚</p>
                </div>
            `;
        }
        console.error("Google Maps authentication failed.");
    };

    // --- Google Maps åˆå§‹åŒ– ---
    function initMap() {
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            console.error("Google Maps API script failed to load.");
            return;
        }
        const taipei = { lat: 25.0330, lng: 121.5654 };
        try {
            map = new google.maps.Map(document.getElementById("map-container"), {
                center: taipei,
                zoom: 12,
                mapId: 'DEMO_MAP_ID', 
                streetViewControl: false,
                mapTypeControl: false,
            });
        } catch (e) {
            console.warn("Map initialization fallback.");
            map = new google.maps.Map(document.getElementById("map-container"), {
                center: taipei,
                zoom: 12,
            });
        }

        placesService = new google.maps.places.PlacesService(map);
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true, 
            polylineOptions: {
                strokeColor: '#0891b2', 
                strokeWeight: 6,
                strokeOpacity: 0.8
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- UI Elements ---
        const ui = {
            inputForm: document.getElementById('input-form'),
            apiKeyInput: document.getElementById('api-key-input'), // New input
            clearKeyBtn: document.getElementById('clear-key-btn'), // New button
            generateBtn: document.getElementById('generate-btn'),
            loader: document.getElementById('loader'),
            travelTip: document.getElementById('travel-tip'),
            resultWrapper: document.getElementById('result-wrapper'),
            resultVisual: document.getElementById('result-visual'),
            resultText: document.getElementById('result-text'),
            resultMap: document.getElementById('result-map'),
            errorMessage: document.getElementById('error-message'),
            formValidationMessage: document.getElementById('form-validation-message'),
            tabVisual: document.getElementById('tab-visual'),
            tabText: document.getElementById('tab-text'),
            tabMap: document.getElementById('tab-map'),
            copyBtn: document.getElementById('copy-btn'),
            resetBtn: document.getElementById('reset-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            interestInput: document.getElementById('interest-input'),
            tagsContainer: document.getElementById('interest-tags-container'),
            suggestedTagsContainer: document.getElementById('suggested-tags'),
            dayTogglesContainer: document.getElementById('day-toggles-container'),
            mapDetailsContainer: document.getElementById('map-details-container'),
            destination: document.getElementById('destination'),
            days: document.getElementById('days'),
            datePicker: document.getElementById('date-picker'),
            travelerType: document.getElementById('traveler-type'),
            pacing: document.getElementById('pacing'),
            budget: document.getElementById('budget'),
            transport: document.getElementById('transport'),
        };
        
        // Restore API Key from localStorage if available
        if (localStorage.getItem('gemini_api_key')) {
            ui.apiKeyInput.value = localStorage.getItem('gemini_api_key');
        }
        
        // Clear Key Button Event
        ui.clearKeyBtn.addEventListener('click', () => {
            ui.apiKeyInput.value = '';
            localStorage.removeItem('gemini_api_key');
            alert('å·²æ¸…é™¤æš«å­˜çš„é‡‘é‘°ï¼Œè«‹é‡æ–°è¼¸å…¥ Gemini API Keyã€‚');
        });
        
        let state = { selectedInterests: [], rawMarkdownContent: '' };
        const suggestedInterests = ['ç¾é£Ÿæ¢ç´¢', 'è‡ªç„¶é¢¨å…‰', 'æ­·å²å¤è¹Ÿ', 'è³¼ç‰©è¡€æ‹¼', 'å‹•æ¼«æ–‡åŒ–', 'å¤œç”Ÿæ´»é«”é©—', 'è—è¡“å±•è¦½', 'ç™»å±±å¥è¡Œ', 'æµ·ç˜æˆ²æ°´', 'åšç‰©é¤¨åƒè§€', 'å’–å•¡å»³å·¡ç¦®', 'æ–‡å‰µå¸‚é›†', 'è¦ªå­æ¨‚åœ’', 'SPAæŒ‰æ‘©', 'æ”å½±æ—…æ‹', 'æº«æ³‰æ”¾é¬†'];
        const travelTips = [
            "å°æç¤ºï¼šä¸‹è¼‰ Google ç¿»è­¯çš„é›¢ç·šèªè¨€åŒ…ï¼Œæ²’æœ‰ç¶²è·¯ä¹Ÿèƒ½æºé€šï¼", "å°æç¤ºï¼šæ—¥æœ¬å¤§éƒ¨åˆ†åº—å®¶ä¸æ¥å—è­°åƒ¹å–”ï¼", "å°æç¤ºï¼šåœ¨æ­æ´²ï¼Œçµ¦æœå‹™ç”Ÿå°è²»æ˜¯å°ä»–å€‘æœå‹™çš„è‚¯å®šã€‚", "å°æç¤ºï¼šå‡ºç™¼å‰ï¼Œç”¨æ‰‹æ©Ÿæ‹ä¸‹è­·ç…§å’Œé‡è¦æ–‡ä»¶ä»¥é˜²è¬ä¸€ã€‚", "å°æç¤ºï¼šå¸¶ä¸€å€‹å¯é‡è¤‡ä½¿ç”¨çš„æ°´ç“¶ï¼Œç’°ä¿åˆçœéŒ¢ã€‚", "AI æ­£åœ¨ç‚ºæ‚¨å°‹æ‰¾ç•¶åœ°äººæ‰çŸ¥é“çš„ç§˜å¢ƒ...", "AI æ­£åœ¨ç‚ºæ‚¨è¦åŠƒæœ€é †æš¢çš„äº¤é€šè·¯ç·š...", "AI æ­£åœ¨ç¢ºèªå„å€‹æ™¯é»çš„ç‡Ÿæ¥­æ™‚é–“..."
        ];

        // --- Tagging System ---
        function renderTags() {
            Array.from(ui.tagsContainer.children).forEach(child => child !== ui.interestInput && ui.tagsContainer.removeChild(child));
            state.selectedInterests.forEach(tagText => {
                const tagEl = document.createElement('span');
                tagEl.className = 'flex items-center bg-cyan-600 text-white text-sm font-medium pl-3 pr-2 py-1 rounded-full cursor-pointer';
                tagEl.textContent = tagText;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'ml-2 text-white/70 hover:text-white focus:outline-none';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    state.selectedInterests = state.selectedInterests.filter(t => t !== tagText);
                    renderTags();
                };
                tagEl.appendChild(removeBtn);
                ui.tagsContainer.insertBefore(tagEl, ui.interestInput);
            });
            ui.interestInput.focus();
        }

        function renderSuggestedTags() {
            ui.suggestedTagsContainer.innerHTML = ''; 
            suggestedInterests.forEach(tagText => {
                const tagEl = document.createElement('button');
                tagEl.className = 'bg-slate-200 text-slate-700 text-sm font-medium px-2 py-1.5 rounded-full hover:bg-slate-300 transform transition-transform hover:scale-105 text-center truncate';
                tagEl.textContent = `+ ${tagText}`;
                tagEl.onclick = (e) => { e.preventDefault(); if (!state.selectedInterests.includes(tagText)) { state.selectedInterests.push(tagText); renderTags(); } };
                ui.suggestedTagsContainer.appendChild(tagEl);
            });
        }
        
        ui.interestInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && ui.interestInput.value.trim() !== '') {
                e.preventDefault();
                const newTag = ui.interestInput.value.trim();
                if (!state.selectedInterests.includes(newTag)) { state.selectedInterests.push(newTag); renderTags(); }
                ui.interestInput.value = '';
            }
        });
        
        // --- Initialization ---
        flatpickr(ui.datePicker, { dateFormat: "Yå¹´mæœˆdæ—¥", locale: "zh_tw" });
        renderSuggestedTags();
        
        // --- Event Listeners ---
        ui.generateBtn.addEventListener('click', handleGenerate);
        ui.tabVisual.addEventListener('click', () => switchTab('visual'));
        ui.tabText.addEventListener('click', () => switchTab('text'));
        ui.tabMap.addEventListener('click', () => switchTab('map'));
        ui.copyBtn.addEventListener('click', copyTextToClipboard);
        ui.resetBtn.addEventListener('click', resetForm);
        ui.exportPdfBtn.addEventListener('click', handleExportPDF);

        function switchTab(tabName) {
            const tabs = { visual: ui.resultVisual, text: ui.resultText, map: ui.resultMap };
            const tabButtons = { visual: ui.tabVisual, text: ui.tabText, map: ui.tabMap };
            
            for (const key in tabs) {
                const isCurrent = key === tabName;
                tabs[key].classList.toggle('hidden', !isCurrent);
                tabButtons[key].className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg ${isCurrent ? 'text-cyan-600 border-cyan-600' : 'text-slate-500 hover:text-slate-700 hover:border-slate-300'}`;
            }
            
            if (tabName === 'map' && dailyLocations.length > 0 && ui.dayTogglesContainer.children.length > 0) {
                 const firstDayButton = ui.dayTogglesContainer.querySelector('button');
                 if(firstDayButton && !firstDayButton.classList.contains('day-toggle-btn-active')) {
                   firstDayButton.click();
                 }
                 setTimeout(() => {
                     if(map) google.maps.event.trigger(map, 'resize');
                 }, 100);
            }
        }

        function resetForm() {
            ui.resultWrapper.classList.add('hidden');
            ui.inputForm.classList.remove('hidden');
            ui.destination.value = '';
            ui.days.value = '';
            ui.datePicker._flatpickr.clear();
            state.selectedInterests = [];
            renderTags();
            ui.formValidationMessage.classList.add('hidden');
            [ui.destination, ui.days, ui.datePicker].forEach(el => el.classList.remove('invalid'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
            dailyLocations = [];
            clearMap();
            ui.dayTogglesContainer.innerHTML = '';
        }
        
        function copyTextToClipboard() {
            if (!state.rawMarkdownContent) return;
            navigator.clipboard.writeText(state.rawMarkdownContent).then(() => {
                const originalText = ui.copyBtn.textContent;
                ui.copyBtn.textContent = 'å·²è¤‡è£½!';
                setTimeout(() => { ui.copyBtn.textContent = originalText; }, 2000);
            }).catch(err => {
                console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
            });
        }

        const icons = {
            description: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10.4 12.6a2 2 0 1 1 3 3L8 21l-4 1 1-4Z"/></svg>`,
            hours: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            transport: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><rect width="18" height="12" x="3" y="5" rx="2"/><path d="M3 11h18"/><path d="m8 17-2 4"/><path d="m18 17-2 4"/></svg>`,
            money: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            youtube: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 4.5 4 7 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2Z"/><path d="m10 9 5 3-5 3Z"/></svg>`,
            booking: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/><path d="M20 12v4H4v-4"/><path d="M20 8.5V4H4v4.5"/><path d="M16 4.5V2"/><path d="M8 4.5V2"/><path d="M4 12h16"/></svg>`,
            tip: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 2.69l.346.666L19.5 15.3l-1.846 3.199H6.346L4.5 15.3l7.154-11.934z"/><path d="M12 22v-3"/><path d="M8 22h8"/></svg>`,
            planB: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M22 12a10.06 10.06 0 0 0-2-5.85"/><path d="M3.5 14.29A9.95 9.95 0 0 0 2 18.5"/><path d="M22 18.5c0-1.79-1.09-4.39-2-5.85"/><path d="M2 12a10.06 10.06 0 0 1 2-5.85"/><path d="M12 2a10.06 10.06 0 0 1 5.85 2"/><path d="M12 22a10.06 10.06 0 0 0-5.85-2"/><path d="M18.35 14.29A9.95 9.95 0 0 1 22 18.5"/><path d="M5.65 9.71A9.95 9.95 0 0 1 2 5.5"/><path d="M5.65 14.29A9.95 9.95 0 0 0 2 18.5"/><path d="M18.35 9.71A9.95 9.95 0 0 0 22 5.5"/></svg>`,
        };
        
        // --- REFACTORED PARSER ---
        function parseAndRenderAll(htmlContent) {
            ui.resultText.innerHTML = htmlContent;
            
            // Create a temporary container for DOM traversal
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            const visualFragment = document.createDocumentFragment();
            dailyLocations = []; 

            let currentDayTitle = '';
            let dayLocations = [];
            let itemIndex = 0;
            let dayIndex = -1;

            // Loop through top-level elements
            Array.from(tempDiv.children).forEach(node => {
                // If H1/P (Intro)
                if (node.tagName === 'H1' || (node.tagName === 'P' && dayIndex === -1)) {
                    visualFragment.appendChild(node.cloneNode(true));
                    return;
                }

                // If H2 (New Day)
                if (node.tagName === 'H2') {
                    // Save previous day if exists
                    if (dayIndex !== -1 && dayLocations.length > 0) {
                        dailyLocations.push({ title: currentDayTitle, locations: [...dayLocations] });
                    }
                    
                    // Start new day
                    dayIndex++;
                    currentDayTitle = node.textContent;
                    dayLocations = [];
                    itemIndex = 0;
                    
                    visualFragment.appendChild(node.cloneNode(true));
                    return;
                }

                // Process content inside a Day
                if (dayIndex !== -1) {
                    // Check for Day Summary (First UL after H2)
                    if (node.tagName === 'UL' && node.textContent.includes('æœ¬æ—¥ä¸»é¡Œ')) {
                        visualFragment.appendChild(createDaySummaryCard(node));
                        return;
                    }

                    // Check for Location Lists
                    if (node.tagName === 'UL') {
                        const cardContainer = document.createElement('div');
                        cardContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6';
                        let hasCards = false;

                        Array.from(node.children).forEach(li => {
                            // Check if LI contains a location
                            // Criterion: Contains a Google Maps link OR (Bold text AND a nested UL)
                            const mapLink = li.querySelector('a[href*="maps"]');
                            const strongTag = li.querySelector('strong');
                            const nestedUl = li.querySelector('ul');

                            if (mapLink || (strongTag && nestedUl)) {
                                const cardId = `card-${dayIndex}-${itemIndex}`;
                                // Extract Name: From link text or strong text
                                let name = '';
                                let query = '';

                                if (mapLink) {
                                    name = mapLink.textContent.replace(/^[-\s*]+|[ğŸ“ğŸœğŸ½ï¸]/g, '').trim();
                                    try {
                                        const url = new URL(mapLink.href);
                                        query = url.searchParams.get('query') || name;
                                    } catch(e) { query = name; }
                                } else if (strongTag) {
                                    name = strongTag.textContent.replace(/^[-\s*]+|[ğŸ“ğŸœğŸ½ï¸]/g, '').trim();
                                    query = name;
                                }

                                if (name) {
                                    hasCards = true;
                                    dayLocations.push({ name: name, query: query, cardId: cardId });
                                    cardContainer.appendChild(createLocationCard(li, cardId, dayIndex, itemIndex));
                                    itemIndex++;
                                }
                            } else {
                                // Just a normal list item, append to a clean UL later or just skip for visual view if mixed
                            }
                        });

                        if (hasCards) {
                            visualFragment.appendChild(cardContainer);
                        } else {
                            // If no cards found in this UL, just render it as normal text
                            visualFragment.appendChild(node.cloneNode(true));
                        }
                        return;
                    }

                    // Render other elements (H3, P, etc.) normally
                    visualFragment.appendChild(node.cloneNode(true));
                }
            });

            // Push last day
            if (dayIndex !== -1 && dayLocations.length > 0) {
                dailyLocations.push({ title: currentDayTitle, locations: [...dayLocations] });
            }

            ui.resultVisual.innerHTML = '';
            ui.resultVisual.appendChild(visualFragment);
            setupDayToggles();
        }

        function createDaySummaryCard(ulElement) {
            const card = document.createElement('div');
            card.className = 'day-summary-card';
            const content = ulElement.innerHTML.replace(/<li>/g, '<div class="flex items-center gap-2 mb-1">').replace(/<\/li>/g, '</div>');
            card.innerHTML = content;
            return card;
        }
        
        function createLocationCard(originalLi, cardId, dayIndex, itemIndex) {
            const card = document.createElement('div');
            card.className = 'info-card';
            card.id = cardId;
            card.dataset.cardId = cardId;

            // Extract basic info
            const mapLink = originalLi.querySelector('a[href*="maps"]');
            let locationName = 'æœªçŸ¥åœ°é»';
            let mapHref = '#';

            if (mapLink) {
                locationName = mapLink.textContent.replace(/^[-\s*]+|[ğŸ“ğŸœğŸ½ï¸]/g, '').trim();
                mapHref = mapLink.href;
            } else {
                const strong = originalLi.querySelector('strong');
                if (strong) locationName = strong.textContent.replace(/^[-\s*]+|[ğŸ“ğŸœğŸ½ï¸]/g, '').trim();
                mapHref = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName)}`;
            }

            // 1. Image Section
            const imageLink = document.createElement('a');
            imageLink.href = mapHref;
            imageLink.target = '_blank';
            imageLink.rel = 'noopener noreferrer';
            imageLink.className = 'info-card-image-link';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'info-card-image-container';
            // Placeholder
            imageContainer.innerHTML = `<div class="animate-pulse bg-gray-300 w-full h-full"></div>`;
            imageLink.appendChild(imageContainer);
            
            const overlay = document.createElement('div');
            overlay.className = 'info-card-image-overlay';
            overlay.textContent = locationName;
            imageLink.appendChild(overlay);
            card.appendChild(imageLink);

            // 2. Content Section
            const contentDiv = document.createElement('div');
            contentDiv.className = 'info-card-content';
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'info-card-details';

            // Process nested list for details
            const nestedUl = originalLi.querySelector('ul');
            if (nestedUl) {
                Array.from(nestedUl.children).forEach(li => {
                    const text = li.textContent.trim();
                    const html = li.innerHTML;
                    
                    let iconHtml = '';
                    let contentHtml = html;

                    // Regex to remove labels like "ç°¡ä»‹ï¼š"
                    const removeLabel = (str) => str.replace(/^[^ï¼š:]+[ï¼š:]\s*/, '');

                    if (text.match(/(ç°¡ä»‹|ä»‹ç´¹)/)) { iconHtml = icons.description; contentHtml = removeLabel(html); }
                    else if (text.match(/(æ™‚é–“|é–‹æ”¾)/)) { iconHtml = icons.hours; contentHtml = removeLabel(html); }
                    else if (text.match(/(å½±ç‰‡|Youtube)/i)) { iconHtml = icons.youtube; contentHtml = removeLabel(html); }
                    else if (text.match(/(èŠ±è²»|é–€ç¥¨|é ç®—)/)) { iconHtml = icons.money; contentHtml = removeLabel(html); }
                    else if (text.match(/(äº¤é€š|åœè»Š)/)) { iconHtml = icons.transport; contentHtml = removeLabel(html); }
                    else if (text.match(/(é è¨‚|è³¼ç¥¨)/)) { iconHtml = icons.booking; contentHtml = removeLabel(html); }
                    else if (text.match(/(æç¤º|å»ºè­°|ç§˜è¨£)/)) { iconHtml = icons.tip; contentHtml = removeLabel(html); }
                    else if (text.match(/(å‚™æ¡ˆ|é›¨å¤©)/)) { iconHtml = icons.planB; contentHtml = removeLabel(html); }
                    else {
                        // Fallback for unidentified items
                        contentHtml = html;
                    }

                    if (iconHtml) {
                        const detailItem = document.createElement('div');
                        detailItem.className = 'detail-item';
                        detailItem.innerHTML = `${iconHtml}<div>${contentHtml}</div>`;
                        detailsDiv.appendChild(detailItem);
                    } else if (text.length > 2) {
                         const detailItem = document.createElement('div');
                        detailItem.className = 'detail-item';
                        detailItem.innerHTML = `<div class="w-[20px]"></div><div>${contentHtml}</div>`;
                        detailsDiv.appendChild(detailItem);
                    }
                });
            }
            contentDiv.appendChild(detailsDiv);

            // Swap Button
            const swapBtn = document.createElement('button');
            swapBtn.className = 'swap-button';
            swapBtn.innerHTML = `ğŸ”„ æ›ä¸€å€‹`;
            swapBtn.dataset.dayIndex = dayIndex;
            swapBtn.dataset.itemIndex = itemIndex;
            swapBtn.dataset.locationName = locationName;
            swapBtn.onclick = handleSwap;
            contentDiv.appendChild(swapBtn);

            card.appendChild(contentDiv);
            return card;
        }
        
        function findAndSetPhoto(locationName, imageContainer) {
             if (!placesService) {
                 const isApiLoaded = typeof google !== 'undefined' && typeof google.maps !== 'undefined';
                 const msg = isApiLoaded ? "åœ°åœ–æœå‹™åˆå§‹ä¸­..." : "åœ°åœ– API é­æ‹’<br><span class='text-xs'>(è«‹æª¢æŸ¥ Console/ç¶²åŸŸé™åˆ¶)</span>";
                 const color = isApiLoaded ? "text-slate-500" : "text-red-500";
                 
                 imageContainer.innerHTML = `<div class="flex flex-col items-center justify-center w-full h-full bg-slate-100 ${color} text-sm p-4 text-center">${msg}</div>`;
                 return;
             }
            const request = {
                query: locationName,
                fields: ['photos'],
            };
            placesService.findPlaceFromQuery(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0 && results[0].photos) {
                    const photoUrl = results[0].photos[0].getUrl({'maxWidth': 400, 'maxHeight': 400});
                    const img = document.createElement('img');
                    img.src = photoUrl;
                    img.alt = `Photo of ${locationName}`;
                    img.className = 'info-card-image';
                    img.onerror = () => {
                         imageContainer.innerHTML = `<div class="flex items-center justify-center w-full h-full bg-slate-100 text-slate-500 text-sm p-4 text-center">åœ–ç‰‡ç„¡æ³•é¡¯ç¤º</div>`;
                    };
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);
                } else {
                    imageContainer.innerHTML = `<div class="flex items-center justify-center w-full h-full bg-slate-100 text-slate-500 text-sm p-4 text-center">ç„¡åœ–ç‰‡è³‡æ–™</div>`;
                }
            });
        }
        
        async function handleSwap(event) {
            const button = event.currentTarget;
            const { dayIndex, itemIndex, locationName } = button.dataset;
            const cardId = `card-${dayIndex}-${itemIndex}`;
            const cardElement = document.getElementById(cardId);
            const apiKey = ui.apiKeyInput.value.trim();

            if (!apiKey) {
                alert("è«‹å…ˆè¼¸å…¥ Gemini API Key æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
                return;
            }
            
            // Safety check again
            if (apiKey === MAPS_API_KEY) {
                alert("æ‚¨è¼¸å…¥çš„æ˜¯åœ°åœ– Keyï¼è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Keyã€‚");
                return;
            }
            
            button.innerHTML = 'AI æ€è€ƒä¸­...';
            button.classList.add('loading');
            button.disabled = true;

            const swapPrompt = `
                è«‹æ ¹æ“šæˆ‘åŸæœ¬çš„æ—…éŠè¡Œç¨‹ï¼Œç‚ºæˆ‘æ›´æ›ä¸€å€‹åœ°é»ã€‚
                - **è¦æ›´æ›çš„åœ°é»**: "${locationName}"
                - **åŸæœ¬çš„è¡Œç¨‹æ¦‚è¦**: ${state.rawMarkdownContent.substring(0, 800)}...
                - **éœ€æ±‚**: è«‹æ¨è–¦ä¸€å€‹ä½æ–¼é™„è¿‘ã€é¡å‹ç›¸ä¼¼ä½†ä¸åŒçš„æ™¯é»æˆ–é¤å»³ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆã€‚
                - **è¼¸å‡ºæ ¼å¼**: **è«‹åªè¼¸å‡ºä¸€å€‹ Markdown çš„ç„¡åºåˆ—è¡¨é … (li)ï¼Œä¸”æ ¼å¼å¿…é ˆå’ŒåŸå§‹é …ç›®å®Œå…¨ä¸€æ¨£**ï¼ŒåŒ…å«åœ°åœ–é€£çµã€ç°¡ä»‹ã€ç›¸é—œå½±ç‰‡ã€ç‡Ÿæ¥­æ™‚é–“ã€èŠ±è²»å’Œäº¤é€šç­‰æ‰€æœ‰ç´°ç¯€ã€‚ä¸è¦è¼¸å‡ºä»»ä½•å…¶ä»–æ–‡å­—æˆ–è§£é‡‹ã€‚
            `;
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: swapPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content) {
                    const newMarkdownLi = result.candidates[0].content.parts[0].text.trim();
                    
                    // Use a temp container to parse the single LI
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = marked.parse(newMarkdownLi);
                    const newLi = tempDiv.querySelector('li');
                    
                    if (newLi) {
                        const newCard = createLocationCard(newLi, cardId, dayIndex, itemIndex);
                        cardElement.replaceWith(newCard);
                        
                        const newLocationName = newCard.querySelector('.info-card-image-overlay').textContent;
                        const newImageContainer = newCard.querySelector('.info-card-image-container');
                        findAndSetPhoto(newLocationName, newImageContainer);

                        // Update data model
                        const newMainLink = newLi.querySelector('a[href*="maps"]');
                        let newQuery = newLocationName;
                        if(newMainLink) {
                             try { newQuery = new URL(newMainLink.href).searchParams.get('query') || newLocationName; } catch(e){}
                        }
                        
                        dailyLocations[dayIndex].locations[itemIndex] = { name: newLocationName, query: newQuery, cardId: cardId };
                        
                        // Refresh map if active
                        const currentDayToggle = ui.dayTogglesContainer.querySelector('.day-toggle-btn-active');
                        if (currentDayToggle && ui.dayTogglesContainer.children[dayIndex] === currentDayToggle) {
                            displayRouteForDay(dayIndex);
                        }
                    }
                }

            } catch (error) {
                console.error("Swap error:", error);
                button.innerHTML = 'æ›´æ›å¤±æ•—';
                alert(`æ›´æ›å¤±æ•—ï¼š${error.message}`);
            } finally {
                 setTimeout(() => {
                     button.innerHTML = 'ğŸ”„ æ›ä¸€å€‹';
                     button.classList.remove('loading');
                     button.disabled = false;
                 }, 2000);
            }
        }
        
        function handleExportPDF() {
            const { jsPDF } = window.jspdf;
            const currentTab = document.querySelector('#result-wrapper nav button.text-cyan-600').id.replace('tab-', '');
            switchTab('visual');
            
            const resultContainer = document.getElementById('result-container');
            const originalBackgroundColor = resultContainer.style.backgroundColor;
            resultContainer.style.backgroundColor = 'white';

            html2canvas(resultContainer, {
                useCORS: true,
                scale: 2,
                onclone: (doc) => {
                    doc.querySelectorAll('.swap-button, .info-card.highlighted, .no-print').forEach(el => {
                        if (el.classList.contains('swap-button')) el.style.display = 'none';
                        if (el.classList.contains('highlighted')) el.classList.remove('highlighted');
                        if (el.classList.contains('no-print')) el.style.display = 'none';
                    });
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const destination = ui.destination.value || 'my-trip';
                pdf.save(`${destination}-itinerary.pdf`);
            }).catch(err => {
                console.error("PDF export failed:", err);
                alert("æŠ±æ­‰ï¼ŒåŒ¯å‡º PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            }).finally(() => {
                resultContainer.style.backgroundColor = originalBackgroundColor;
                switchTab(currentTab);
            });
        }
        
        // --- Map Logic ---
        function setupDayToggles() {
            ui.dayTogglesContainer.innerHTML = '';
            dailyLocations.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.textContent = day.title.replace(/^##\s*/, '').split('ï¼š')[0] || `ç¬¬ ${index + 1} å¤©`;
                btn.className = 'day-toggle-btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all';
                btn.onclick = () => {
                    displayRouteForDay(index);
                    ui.dayTogglesContainer.querySelectorAll('button').forEach(b => b.classList.remove('day-toggle-btn-active'));
                    btn.classList.add('day-toggle-btn-active');
                };
                ui.dayTogglesContainer.appendChild(btn);
            });
        }

        function clearMap() {
            if (markers) markers.forEach(marker => marker.map = null);
            markers = [];
            if(directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            if (renderers) renderers.forEach(r => r.setMap(null));
            renderers = [];
            if (ui.mapDetailsContainer) ui.mapDetailsContainer.innerHTML = '';
        }
        
        async function displayRouteForDay(dayIndex) {
            clearMap();
            if (!dailyLocations[dayIndex] || dailyLocations[dayIndex].locations.length === 0) return;
        
            const dayData = dailyLocations[dayIndex];
            
            // Batch geocoding
            const placePromises = dayData.locations.map(loc => {
                const request = { query: loc.query, fields: ['name', 'geometry', 'place_id'] };
                return new Promise(resolve => {
                    placesService.findPlaceFromQuery(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0].geometry) {
                            resolve({ ...loc, ...results[0], position: results[0].geometry.location });
                        } else {
                            resolve(null);
                        }
                    });
                });
            });

            const allGeocodedLocations = (await Promise.all(placePromises)).filter(Boolean);
            
            if (allGeocodedLocations.length === 0) {
                ui.mapDetailsContainer.innerHTML = '<p class="text-red-500">æŠ±æ­‰ï¼Œæ­¤å¤©çš„åœ°é»å‡ç„¡æ³•åœ¨åœ°åœ–ä¸Šå®šä½ã€‚</p>';
                return;
            }
            
            const bounds = new google.maps.LatLngBounds();
            const uniqueGeocodedLocations = [];
            const placeIdSet = new Set();

            allGeocodedLocations.forEach((loc, i) => {
                bounds.extend(loc.position);
                
                const marker = new google.maps.Marker({
                    position: loc.position, 
                    map, 
                    title: `${i + 1}. ${loc.name}`, 
                    label: { text: `${i+1}`, color: "white" }
                });

                 marker.addListener('click', () => highlightCardAndScroll(loc.cardId));
                 markers.push(marker);
                 
                 if (!placeIdSet.has(loc.place_id)) {
                     uniqueGeocodedLocations.push(loc);
                     placeIdSet.add(loc.place_id);
                 }
            });
            map.fitBounds(bounds);
        
            // Routing
            if (uniqueGeocodedLocations.length > 1) {
                const travelMode = ui.transport.value === 'ç§Ÿè»Šè‡ªé§•' ? google.maps.TravelMode.DRIVING : google.maps.TravelMode.TRANSIT;
                ui.mapDetailsContainer.innerHTML = '';

                // Placeholders
                for (let i = 0; i < uniqueGeocodedLocations.length - 1; i++) {
                    const placeholder = document.createElement('div');
                    placeholder.id = `leg-placeholder-${i}`;
                    ui.mapDetailsContainer.appendChild(placeholder);
                }

                if (travelMode === google.maps.TravelMode.DRIVING) {
                    const request = {
                        origin: uniqueGeocodedLocations[0].position, 
                        destination: uniqueGeocodedLocations[uniqueGeocodedLocations.length - 1].position,
                        waypoints: uniqueGeocodedLocations.slice(1, -1).map(loc => ({ location: loc.position, stopover: true })),
                        travelMode: travelMode
                    };
                    directionsService.route(request, (response, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(response);
                            renderMapDetails(response.routes[0].legs, uniqueGeocodedLocations, travelMode);
                        }
                    });
                } else {
                    // Sequential Transit
                    uniqueGeocodedLocations.slice(0, -1).forEach((startLoc, i) => {
                        const endLoc = uniqueGeocodedLocations[i+1];
                        const legRequest = {
                            origin: startLoc.position,
                            destination: endLoc.position,
                            travelMode: google.maps.TravelMode.TRANSIT
                        };
                        
                        directionsService.route(legRequest, (response, status) => {
                            if (status === google.maps.DirectionsStatus.OK) {
                                const legRenderer = new google.maps.DirectionsRenderer({
                                    map: map, directions: response, suppressMarkers: true, preserveViewport: true,
                                    polylineOptions: { strokeColor: '#06b6d4', strokeWeight: 5, strokeOpacity: 0.7 }
                                });
                                renderers.push(legRenderer);
                                renderSingleMapDetail(response.routes[0].legs[0], startLoc, endLoc, i, google.maps.TravelMode.TRANSIT);
                            } else {
                                // Fallback to Walking
                                legRequest.travelMode = google.maps.TravelMode.WALKING;
                                directionsService.route(legRequest, (walkResponse, walkStatus) => {
                                    if (walkStatus === google.maps.DirectionsStatus.OK) {
                                        const legRenderer = new google.maps.DirectionsRenderer({
                                            map: map, directions: walkResponse, suppressMarkers: true, preserveViewport: true,
                                            polylineOptions: { strokeColor: '#16a34a', strokeWeight: 6, strokeOpacity: 0.8, icons: [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 }, offset: '0', repeat: '20px'}] }
                                        });
                                        renderers.push(legRenderer);
                                        renderSingleMapDetail(walkResponse.routes[0].legs[0], startLoc, endLoc, i, google.maps.TravelMode.WALKING);
                                    } else {
                                        renderErrorLeg(startLoc, endLoc, i);
                                    }
                                });
                            }
                        });
                    });
                }
            } else {
                ui.mapDetailsContainer.innerHTML = '<p class="text-slate-500 p-4 text-center">åœ°é»å¤ªå°‘ï¼Œç„¡éœ€è¦åŠƒè·¯ç·šã€‚</p>';
            }
        }
        
        function renderMapDetails(legs, locations, travelMode) {
             legs.forEach((leg, i) => {
                 renderSingleMapDetail(leg, locations[i], locations[i+1], i, travelMode);
             });
        }
        
        function renderSingleMapDetail(leg, startLoc, endLoc, index, travelMode) {
            const placeholder = document.getElementById(`leg-placeholder-${index}`);
            if (!placeholder) return;

            const detailLink = document.createElement('a');
            detailLink.className = 'map-leg-detail-link';
            detailLink.target = '_blank';
            detailLink.rel = 'noopener noreferrer';
            
            const mode = travelMode.toLowerCase();
            const icon = mode === 'driving' ? 'ğŸš—' : (mode === 'walking' ? 'ğŸš¶' : 'ğŸš‡');
            
            detailLink.href = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(startLoc.name)}&destination=${encodeURIComponent(endLoc.name)}&travelmode=${mode}`;

            const detailEl = document.createElement('div');
            detailEl.className = 'map-leg-detail';
            detailEl.innerHTML = `
                <div class="flex flex-col items-center self-stretch">
                    <span class="bg-cyan-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm flex-shrink-0">${index + 1}</span>
                    <div class="h-8 border-l-2 border-slate-300 border-dashed my-1"></div>
                    <span class="bg-cyan-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm flex-shrink-0">${index + 2}</span>
                </div>
                <div class="flex-grow py-1">
                        <div class="font-bold text-slate-800 truncate">${startLoc.name}</div>
                        <div class="text-sm text-slate-500 my-1 flex items-center gap-2">
                            <span>${icon}</span>
                            <span>${leg.duration.text}</span>
                            <span class="text-xs bg-slate-100 px-2 py-0.5 rounded">${leg.distance.text}</span>
                        </div>
                        <div class="font-bold text-slate-800 truncate">${endLoc.name}</div>
                </div>
                <div class="text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </div>
            `;
            detailLink.appendChild(detailEl);
            placeholder.replaceWith(detailLink);
        }
        
        function renderErrorLeg(startLoc, endLoc, index) {
            const placeholder = document.getElementById(`leg-placeholder-${index}`);
            if (!placeholder) return;

            const errorDiv = document.createElement('div');
            errorDiv.className = 'map-leg-detail';
            errorDiv.innerHTML = `
                <div class="flex flex-col items-center self-stretch">
                    <span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 1}</span>
                    <div class="h-8 border-l-2 border-slate-300 border-dashed my-1"></div>
                    <span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 2}</span>
                </div>
                <div class="flex-grow py-1">
                        <div class="font-bold text-slate-800">${startLoc.name}</div>
                        <div class="text-red-500 text-sm my-1">ç„¡æ³•è¦åŠƒè·¯ç·š</div>
                        <div class="font-bold text-slate-800">${endLoc.name}</div>
                </div>
            `;
            placeholder.replaceWith(errorDiv);
        }

        function highlightCardAndScroll(cardId) {
            if (ui.resultVisual.classList.contains('hidden')) {
                switchTab('visual');
            }
            document.querySelectorAll('.info-card').forEach(c => c.classList.remove('highlighted'));
            const cardElement = document.getElementById(cardId);
            if(cardElement) {
                cardElement.classList.add('highlighted');
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // --- Main Generation Logic ---
        function validateInputs() {
            const requiredFields = [
                { el: ui.destination, name: "ç›®çš„åœ°" },
                { el: ui.days, name: "ç¸½å¤©æ•¸" },
                { el: ui.datePicker, name: "å‡ºç™¼æ—¥æœŸ" },
                { el: ui.apiKeyInput, name: "Gemini API Key" }
            ];
            let missingFields = [];

            requiredFields.forEach(field => {
                if (!field.el.value.trim()) {
                    missingFields.push(field.name);
                    field.el.classList.add('invalid');
                } else {
                    field.el.classList.remove('invalid');
                }
            });

            if (missingFields.length > 0) {
                ui.formValidationMessage.textContent = `è«‹å¡«å¯«å¿…è¦çš„æ¬„ä½ï¼š${missingFields.join('ã€')}`;
                ui.formValidationMessage.classList.remove('hidden');
                return false;
            }
            
            // Check if user mistakenly pasted the Maps API Key
            const inputKey = ui.apiKeyInput.value.trim();
            if (inputKey === MAPS_API_KEY) {
                ui.formValidationMessage.innerHTML = `
                    <strong>âš ï¸ é‡‘é‘°éŒ¯èª¤è­¦å‘Š</strong><br>
                    æ‚¨ä¼¼ä¹å¡«å…¥äº†ç¨‹å¼ç¢¼ä¸­é è¨­çš„åœ°åœ– Keyï¼Œè€Œä¸æ˜¯æ‚¨çš„ Gemini API Keyã€‚<br>
                    è«‹ç¢ºèªæ‚¨æ˜¯å¾ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a> ç”³è«‹çš„ Gemini é‡‘é‘°ã€‚
                `;
                ui.formValidationMessage.classList.remove('hidden');
                return false;
            }

            ui.formValidationMessage.classList.add('hidden');
            return true;
        }

        async function handleGenerate() {
            if (!validateInputs()) {
                return;
            }

            ui.errorMessage.classList.add('hidden');
            ui.inputForm.classList.add('hidden');
            ui.loader.classList.remove('hidden');
            ui.resultWrapper.classList.add('hidden');
            ui.generateBtn.disabled = true;

            travelTipsInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * travelTips.length);
                ui.travelTip.textContent = travelTips[randomIndex];
            }, 2500);

            dailyLocations = [];
            clearMap();
            ui.dayTogglesContainer.innerHTML = '';
            
            let interestPrompt = state.selectedInterests.length > 0 ? `- **ä¸»è¦èˆˆè¶£ï¼š** ${state.selectedInterests.join('ã€')}` : '';

            // OPTIMIZED PROMPT FOR ROBUST PARSING
            const userPrompt = `
# è§’è‰²æ‰®æ¼”
ä½ æ˜¯ä¸€ä½æ“æœ‰20å¹´ç¶“é©—çš„é ‚å°–æ—…éŠè¦åŠƒå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºä½¿ç”¨è€…ç”Ÿæˆä¸€ä»½ Markdown æ ¼å¼çš„æ—…éŠè¡Œç¨‹ã€‚

# æ—…éŠéœ€æ±‚
- **ç›®çš„åœ°ï¼š** ${ui.destination.value}
- **å¤©æ•¸ï¼š** ${ui.days.value}
- **æ—¥æœŸï¼š** ${ui.datePicker.value}
- **æ—…è¡Œè€…é¡å‹ï¼š** ${ui.travelerType.value}
- **æ­¥èª¿ï¼š** ${ui.pacing.value}
- **é ç®—ï¼š** ${ui.budget.value}
- **äº¤é€šï¼š** ${ui.transport.value}
${interestPrompt}

# è¼¸å‡ºæ ¼å¼è¦å‰‡ (å¿…é ˆåš´æ ¼éµå®ˆ)

1. **æ¯æ—¥æ¨™é¡Œ**ï¼šæ¯ä¸€å¤©å¿…é ˆä»¥ H2 æ¨™é¡Œé–‹å§‹ï¼Œæ ¼å¼ï¼š\`## ç¬¬ä¸€å¤©ï¼š[ä¸»é¡Œ]\`ã€‚
2. **æ¯æ—¥æ‘˜è¦**ï¼šåœ¨ H2 ä¸‹æ–¹ï¼Œä½¿ç”¨ä¸€å€‹ç„¡åºåˆ—è¡¨åˆ—å‡ºæœ¬æ—¥æ‘˜è¦ (ä¸»é¡Œã€é ç®—ã€æ­¥èª¿ã€äº¤é€š)ã€‚
3. **æ™‚æ®µ**ï¼šä½¿ç”¨ H3 æ¨™é¡Œå€åˆ†æ™‚æ®µ (ä¾‹å¦‚ \`### ä¸Šåˆ\`)ã€‚
4. **æ™¯é»/é¤å»³ (é—œéµæ ¼å¼)**ï¼š
   - æ¯å€‹åœ°é»å¿…é ˆæ˜¯ä¸€å€‹**ç„¡åºåˆ—è¡¨é …ç›® (- )**ã€‚
   - ç¬¬ä¸€è¡Œå¿…é ˆåŒ…å« **Google Maps é€£çµ**ï¼Œæ ¼å¼ç‚ºï¼š\`- [åœ°é»åç¨±](https://www.google.com/maps/search/?api=1&query=åœ°é»åç¨±)\`ã€‚
   - åœ°é»è©³æƒ…å¿…é ˆæ˜¯**å·¢ç‹€åˆ—è¡¨**ï¼ŒåŒ…å«ï¼šç°¡ä»‹ã€ç‡Ÿæ¥­æ™‚é–“ã€èŠ±è²»ã€äº¤é€šã€é è¨‚ã€å°ˆå®¶æç¤ºã€é›¨å¤©å‚™æ¡ˆã€‚

ç¯„ä¾‹çµæ§‹ï¼š
## ç¬¬ä¸€å¤©ï¼šæŠµé”æ±äº¬
* â˜€ï¸ æœ¬æ—¥ä¸»é¡Œï¼šåŸå¸‚æ¢ç´¢
...
### ä¸Šåˆ
- [æ·ºè‰å¯º](https://www.google.com/maps/search/?api=1&query=æ·ºè‰å¯º)
  - ç°¡ä»‹ï¼šæ±äº¬æœ€å¤è€çš„å¯ºå»Ÿ...
  - ç‡Ÿæ¥­æ™‚é–“ï¼š06:00-17:00
  - èŠ±è²»ï¼šå…è²»
  - äº¤é€šï¼šåœ°éµæ·ºè‰ç«™æ­¥è¡Œ5åˆ†é˜
...
`;
            try {
                const apiKey = ui.apiKeyInput.value.trim();
                
                // Store API key in localStorage for convenience
                localStorage.setItem('gemini_api_key', apiKey);

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: userPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                    let errorMsg = `API è«‹æ±‚å¤±æ•— (${response.status})`;
                    try { 
                        const err = await response.json(); 
                        if (err.error && err.error.message) {
                            errorMsg = err.error.message;
                        }
                    } catch(e){}
                    throw new Error(errorMsg);
                }
                
                let result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text || text.trim().length < 100) {
                    throw new Error("AI ç”Ÿæˆå…§å®¹ç„¡æ•ˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
                
                state.rawMarkdownContent = text;
                const htmlContent = marked.parse(state.rawMarkdownContent);
                
                parseAndRenderAll(htmlContent);

                const cards = ui.resultVisual.querySelectorAll('.info-card');
                cards.forEach(card => {
                    const locationName = card.querySelector('.info-card-image-overlay').textContent;
                    const imageContainer = card.querySelector('.info-card-image-container');
                    findAndSetPhoto(locationName, imageContainer);
                });

                ui.resultWrapper.classList.remove('hidden');
                switchTab('visual');
                ui.resultWrapper.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error generating itinerary:', error);
                
                let displayMessage = `ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
                
                // Specific handling for API not enabled error
                if (error.message.includes("Generative Language API") && (error.message.includes("disabled") || error.message.includes("has not been used"))) {
                    displayMessage = `
                        <div class="text-left">
                            <strong>ğŸš« API æ¬Šé™éŒ¯èª¤ (403)</strong><br><br>
                            é€™é€šå¸¸æ˜¯å› ç‚ºæ‚¨ä½¿ç”¨çš„ API Key <strong>æ²’æœ‰å•Ÿç”¨ Gemini æ¬Šé™</strong>ã€‚<br>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li>æª¢æŸ¥æ‚¨æ˜¯å¦èª¤ç”¨äº† <strong>Google Maps API Key</strong> (é€šå¸¸æ˜¯ AIzaSyB... é–‹é ­)ã€‚</li>
                                <li>Gemini API Key é€šå¸¸éœ€è¦åœ¨ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline text-blue-600 font-bold">Google AI Studio</a> å¦å¤–ç”³è«‹ã€‚</li>
                                <li>å¦‚æœæ˜¯åŒä¸€å€‹å°ˆæ¡ˆï¼Œè«‹ç¢ºèªå·²åœ¨ Google Cloud Console å•Ÿç”¨ "Generative Language API"ã€‚</li>
                            </ul>
                            <div class="mt-4 text-center">
                                <button onclick="document.getElementById('clear-key-btn').click(); document.getElementById('error-message').classList.add('hidden'); document.getElementById('input-form').classList.remove('hidden');" class="bg-red-100 text-red-700 border border-red-300 px-4 py-2 rounded hover:bg-red-200">
                                    æ¸…é™¤éŒ¯èª¤ Key ä¸¦é‡è©¦
                                </button>
                            </div>
                        </div>
                    `;
                }

                ui.errorMessage.innerHTML = displayMessage; 
                ui.inputForm.classList.remove('hidden'); // Keep form visible so they can change key
                ui.loader.classList.add('hidden'); // Ensure loader is hidden
                ui.errorMessage.classList.remove('hidden');
            } finally {
                clearInterval(travelTipsInterval);
                ui.travelTip.textContent = '';
                ui.loader.classList.add('hidden');
                ui.generateBtn.disabled = false;
            }
        }
    });
    </script>
</body>
</html>
