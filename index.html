<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—…éŠè¡Œç¨‹è¦åŠƒå¸« v13.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœˆï¸</text></svg>">
    <style>
        :root {
            --primary-color: #0891b2; /* Teal-600 */
            --primary-color-hover: #06b6d4; /* Cyan-500 */
            --secondary-bg: #f0f9ff; /* Sky-50 */
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--secondary-bg); 
            color: #334155; /* Slate-700 */
        }
        .form-input:focus, .flatpickr-input:focus { 
            --tw-ring-color: var(--primary-color-hover);
            border-color: var(--primary-color-hover);
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        .main-title {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-color-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- çµæœå€åŸŸæ¨£å¼ --- */
        #result-container h1 { font-size: 2.25rem; font-weight: bold; margin-bottom: 1rem; color: #1e293b; }
        #result-container h2 { font-size: 1.75rem; font-weight: bold; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; margin-top: 3rem; margin-bottom: 1.5rem; color: var(--primary-color); }
        #result-text h3, #result-visual h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; color: #334155; padding-left: 0.5rem; border-left: 4px solid var(--primary-color-hover); }

        .info-card {
            background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            overflow: hidden; margin-bottom: 1.5rem; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; position: relative;
        }
        .info-card:hover, .info-card.highlighted {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-color: var(--primary-color);
        }
        .info-card-image-link { display: block; position: relative; }
        .info-card-image-container { width: 100%; height: 180px; background-color: #e0f2fe; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .info-card-image { width: 100%; height: 100%; object-fit: cover; }
        .info-card-image-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 1.5rem 0.75rem 0.75rem; color: white; font-weight: bold; font-size: 1.1rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .info-card-content { padding: 1rem 1.25rem; flex-grow: 1; padding-bottom: 3.5rem; }
        .info-card-details { display: flex; flex-direction: column; gap: 0.75rem; color: #475569; }
        .info-card-details .detail-item { display: flex; align-items: flex-start; gap: 0.75rem; word-break: break-word; }
        .info-card-details .detail-icon { width: 20px; height: 20px; flex-shrink: 0; color: var(--primary-color); margin-top: 2px;}
        .info-card-details a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .info-card-details a:hover { text-decoration: underline; }
        
        .swap-button {
            position: absolute; bottom: 0.75rem; right: 1.25rem; background-color: var(--primary-color); color: white; border: none;
            border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s; display: flex; align-items: center; gap: 0.25rem;
        }
        .swap-button:hover { background-color: var(--primary-color-hover); }
        .swap-button.loading { cursor: not-allowed; background-color: #94a3b8; }
        
        .day-summary-card { background-color: #f0f9ff; border: 1px solid #bae6fd; border-left-width: 5px; border-left-color: var(--primary-color); padding: 1rem 1.5rem; margin-bottom: 2rem; border-radius: 0.5rem; }

        #map-container { width: 100%; height: 55vh; border-radius: 0.75rem; overflow: hidden; background-color: #e2e8f0; }
        .day-toggle-btn { transition: all 0.2s ease-in-out; }
        .day-toggle-btn-active { background-color: var(--primary-color) !important; color: white !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .map-leg-detail-link { display: block; text-decoration: none; }
        .map-leg-detail { background-color: #f8fafc; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; transition: background-color 0.2s; cursor: pointer; }
        .map-leg-detail-link:hover .map-leg-detail { background-color: #e0f2fe; }
        .map-leg-detail.highlighted { background-color: #e0f2fe; }
    </style>
    <!-- Google Maps API è…³æœ¬ (ADDED places library) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY&callback=initMap&libraries=marker,routes,geocoding,places"></script>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold main-title mb-3">AI æ—…éŠè¡Œç¨‹è¦åŠƒå¸« v13.8</h1>
            <p class="text-lg text-slate-500">è¼¸å…¥æ‚¨çš„æ—…éŠéˆæ„Ÿï¼Œå³åˆ»ç”Ÿæˆå°ˆæ¥­ç´šè¦–è¦ºåŒ–è¡Œç¨‹èˆ‡åœ°åœ–è·¯ç·š</p>
        </div>

        <div id="input-form" class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <div>
                        <label for="destination" class="block text-md font-medium text-slate-700 mb-2">ğŸŒ ç›®çš„åœ°</label>
                        <input type="text" id="destination" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬äº¬éƒ½ã€ç‘å£«å°‘å¥³å³°" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="days" class="block text-md font-medium text-slate-700 mb-2">â³ ç¸½å¤©æ•¸</label>
                            <input type="number" id="days" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="ä¾‹å¦‚ï¼š5" min="1" required>
                        </div>
                        <div>
                            <label for="date-picker" class="block text-md font-medium text-slate-700 mb-2">ğŸ—“ï¸ å‡ºç™¼æ—¥æœŸ</label>
                            <input type="text" id="date-picker" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white" placeholder="é¸æ“‡å‡ºç™¼æ—¥æœŸ" required>
                        </div>
                    </div>
                    <div>
                        <label for="traveler-type" class="block text-md font-medium text-slate-700 mb-2">âœˆï¸ æ—…è¡Œè€…é¡å‹</label>
                        <select id="traveler-type" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                            <option>æƒ…ä¾¶èœœæœˆ</option><option>è¦ªå­å®¶åº­</option><option>ç¨è‡ªèƒŒåŒ…æ¢éšª</option><option>ä¸‰äº”å¥½å‹è¼•æ—…è¡Œ</option><option>é€€ä¼‘æ¨‚æ´»æ—</option><option>å•†å‹™å·®æ—…</option>
                        </select>
                    </div>
                     <div>
                        <label for="transport" class="block text-md font-medium text-slate-700 mb-2">ğŸš‡ ä¸»è¦äº¤é€šæ–¹å¼</label>
                        <select id="transport" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                            <option value="æ··åˆ(å¤§çœ¾é‹è¼¸ç‚ºä¸»)">æ··åˆ(å¤§çœ¾é‹è¼¸ç‚ºä¸»)</option>
                            <option value="ç§Ÿè»Šè‡ªé§•">ç§Ÿè»Šè‡ªé§•</option>
                        </select>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="space-y-6">
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pacing" class="block text-md font-medium text-slate-700 mb-2">ğŸƒâ€â™‚ï¸ æ—…è¡Œæ­¥èª¿</label>
                            <select id="pacing" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="æ¨™æº–é©ä¸­">æ¨™æº–é©ä¸­ (é è¨­)</option>
                                <option value="æ‚ é–’æ”¾é¬†">æ‚ é–’æ”¾é¬†</option>
                                <option value="ç·Šæ¹Šå……å¯¦">ç·Šæ¹Šå……å¯¦</option>
                            </select>
                        </div>
                        <div>
                            <label for="budget" class="block text-md font-medium text-slate-700 mb-2">ğŸ’° é ç®—ç­‰ç´š</label>
                            <select id="budget" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="å¹³è¡¡èˆ’é©">å¹³è¡¡èˆ’é© (é è¨­)</option>
                                <option value="ç¶“æ¿Ÿå¯¦æƒ ">ç¶“æ¿Ÿå¯¦æƒ </option>
                                <option value="å¥¢è¯äº«å—">å¥¢è¯äº«å—</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-col h-full">
                        <label class="block text-md font-medium text-slate-700">ğŸ¨ ä¸»è¦èˆˆè¶£åå¥½ (é¸å¡«)</label>
                        <div id="interest-tags-container" class="flex flex-wrap gap-2 p-3 border border-slate-300 rounded-lg bg-slate-50 mt-2 min-h-[50px] items-center flex-grow">
                            <input type="text" id="interest-input" class="flex-grow bg-transparent focus:outline-none" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter æ–°å¢...">
                        </div>
                        <div id="suggested-tags" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="generate-btn" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center justify-center mx-auto gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L11.8 9.2a1.21 1.21 0 0 0 0 1.72l5.8 5.8a1.21 1.21 0 0 0 1.72 0l6.84-6.84a1.21 1.21 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-2"/><path d="M11 11 8 8"/><path d="M15 15l3 3"/><path d="m5 21 3-3"/></svg>
                    <span>ç”Ÿæˆéˆæ„Ÿè¡Œç¨‹</span>
                </button>
            </div>
        </div>


        <div id="loader" class="hidden text-center my-10">
            <svg class="animate-spin h-12 w-12 text-cyan-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-slate-600 font-medium">AI æ­£åœ¨æ®å‹•é­”æ³•æ£’ï¼Œç‚ºæ‚¨å®¢è£½åŒ–å°ˆå±¬è¡Œç¨‹...</p>
            <p id="travel-tip" class="mt-3 text-sm text-slate-500 h-5"></p>
        </div>
        
        <div id="error-message" class="hidden text-center my-10 max-w-2xl mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"></div>

        <div id="result-wrapper" class="hidden mt-10 max-w-7xl mx-auto">
             <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                 <div class="border-b border-slate-200"><nav class="-mb-px flex space-x-2 sm:space-x-6" aria-label="Tabs">
                     <button id="tab-visual" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">âœ¨ è¦–è¦ºåŒ–è¡Œç¨‹</button>
                     <button id="tab-text" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">ğŸ“„ ç´”æ–‡å­—ç‰ˆ</button>
                     <button id="tab-map" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">ğŸ“ åœ°åœ–æ¨¡å¼</button>
                 </nav></div>
                 <div class="flex items-center gap-2">
                     <button id="copy-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">è¤‡è£½æ–‡å­—</button>
                     <button id="export-pdf-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">åŒ¯å‡º PDF</button>
                     <button id="reset-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">é‡æ–°è¦åŠƒ</button>
                 </div>
             </div>
             <div id="result-container" class="bg-white p-4 sm:p-6 md:p-10 rounded-2xl shadow-xl">
                 <div id="result-visual"></div>
                 <div id="result-text" class="hidden prose max-w-none"></div>
                 <div id="result-map" class="hidden">
                     <div id="day-toggles-container" class="flex flex-wrap gap-2 mb-4"></div>
                     <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                         <div class="md:col-span-8 lg:col-span-9">
                              <div id="map-container"></div>
                         </div>
                         <div class="md:col-span-4 lg:col-span-3 max-h-[55vh] overflow-y-auto pr-2">
                              <div id="map-details-container" class="space-y-3"></div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>
    </div>

    <script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let map;
    let placesService;
    let directionsService;
    let directionsRenderer;
    let dailyLocations = []; 
    let markers = []; 
    let renderers = []; 
    let travelTipsInterval;

    // --- Google Maps åˆå§‹åŒ– ---
    function initMap() {
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            console.error("Google Maps API script failed to load.");
            document.getElementById('error-message').textContent = 'åœ°åœ–æœå‹™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚';
            document.getElementById('error-message').classList.remove('hidden');
            return;
        }
        const taipei = { lat: 25.0330, lng: 121.5654 };
        map = new google.maps.Map(document.getElementById("map-container"), {
            center: taipei,
            zoom: 12,
            mapId: 'DEMO_MAP_ID', // Replace with your Map ID for production
            streetViewControl: false,
            mapTypeControl: false,
        });
        placesService = new google.maps.places.PlacesService(map);
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true, 
            polylineOptions: {
                strokeColor: '#0891b2', 
                strokeWeight: 6,
                strokeOpacity: 0.8
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- API KEYS ---
        // IMPORTANT: Replace with your actual Gemini API Key
        const GEMINI_API_KEY = "";

        // --- UI Elements ---
        const ui = {
            inputForm: document.getElementById('input-form'),
            generateBtn: document.getElementById('generate-btn'),
            loader: document.getElementById('loader'),
            travelTip: document.getElementById('travel-tip'),
            resultWrapper: document.getElementById('result-wrapper'),
            resultVisual: document.getElementById('result-visual'),
            resultText: document.getElementById('result-text'),
            resultMap: document.getElementById('result-map'),
            errorMessage: document.getElementById('error-message'),
            tabVisual: document.getElementById('tab-visual'),
            tabText: document.getElementById('tab-text'),
            tabMap: document.getElementById('tab-map'),
            copyBtn: document.getElementById('copy-btn'),
            resetBtn: document.getElementById('reset-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            interestInput: document.getElementById('interest-input'),
            tagsContainer: document.getElementById('interest-tags-container'),
            suggestedTagsContainer: document.getElementById('suggested-tags'),
            dayTogglesContainer: document.getElementById('day-toggles-container'),
            mapDetailsContainer: document.getElementById('map-details-container'),
            destination: document.getElementById('destination'),
            days: document.getElementById('days'),
            datePicker: document.getElementById('date-picker'),
            travelerType: document.getElementById('traveler-type'),
            pacing: document.getElementById('pacing'),
            budget: document.getElementById('budget'),
            transport: document.getElementById('transport'),
        };
        
        let state = { selectedInterests: [], rawMarkdownContent: '' };
        const suggestedInterests = ['ç¾é£Ÿæ¢ç´¢', 'è‡ªç„¶é¢¨å…‰', 'æ­·å²å¤è¹Ÿ', 'è³¼ç‰©è¡€æ‹¼', 'å‹•æ¼«æ–‡åŒ–', 'å¤œç”Ÿæ´»é«”é©—', 'è—è¡“å±•è¦½', 'ç™»å±±å¥è¡Œ', 'æµ·ç˜æˆ²æ°´', 'åšç‰©é¤¨åƒè§€', 'å’–å•¡å»³å·¡ç¦®', 'æ–‡å‰µå¸‚é›†', 'è¦ªå­æ¨‚åœ’', 'SPAæŒ‰æ‘©', 'æ”å½±æ—…æ‹', 'æº«æ³‰æ”¾é¬†'];
        const travelTips = [
            "å°æç¤ºï¼šä¸‹è¼‰ Google ç¿»è­¯çš„é›¢ç·šèªè¨€åŒ…ï¼Œæ²’æœ‰ç¶²è·¯ä¹Ÿèƒ½æºé€šï¼", "å°æç¤ºï¼šæ—¥æœ¬å¤§éƒ¨åˆ†åº—å®¶ä¸æ¥å—è­°åƒ¹å–”ï¼", "å°æç¤ºï¼šåœ¨æ­æ´²ï¼Œçµ¦æœå‹™ç”Ÿå°è²»æ˜¯å°ä»–å€‘æœå‹™çš„è‚¯å®šã€‚", "å°æç¤ºï¼šå‡ºç™¼å‰ï¼Œç”¨æ‰‹æ©Ÿæ‹ä¸‹è­·ç…§å’Œé‡è¦æ–‡ä»¶ä»¥é˜²è¬ä¸€ã€‚", "å°æç¤ºï¼šå¸¶ä¸€å€‹å¯é‡è¤‡ä½¿ç”¨çš„æ°´ç“¶ï¼Œç’°ä¿åˆçœéŒ¢ã€‚", "AI æ­£åœ¨ç‚ºæ‚¨å°‹æ‰¾ç•¶åœ°äººæ‰çŸ¥é“çš„ç§˜å¢ƒ...", "AI æ­£åœ¨ç‚ºæ‚¨è¦åŠƒæœ€é †æš¢çš„äº¤é€šè·¯ç·š...", "AI æ­£åœ¨ç¢ºèªå„å€‹æ™¯é»çš„ç‡Ÿæ¥­æ™‚é–“..."
        ];

        // --- Tagging System ---
        function renderTags() {
            Array.from(ui.tagsContainer.children).forEach(child => child !== ui.interestInput && ui.tagsContainer.removeChild(child));
            state.selectedInterests.forEach(tagText => {
                const tagEl = document.createElement('span');
                tagEl.className = 'flex items-center bg-cyan-600 text-white text-sm font-medium pl-3 pr-2 py-1 rounded-full cursor-pointer';
                tagEl.textContent = tagText;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'ml-2 text-white/70 hover:text-white focus:outline-none';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    state.selectedInterests = state.selectedInterests.filter(t => t !== tagText);
                    renderTags();
                };
                tagEl.appendChild(removeBtn);
                ui.tagsContainer.insertBefore(tagEl, ui.interestInput);
            });
            ui.interestInput.focus();
        }

        function renderSuggestedTags() {
            ui.suggestedTagsContainer.innerHTML = ''; 
            suggestedInterests.forEach(tagText => {
                const tagEl = document.createElement('button');
                tagEl.className = 'bg-slate-200 text-slate-700 text-sm font-medium px-3 py-1 rounded-full hover:bg-slate-300 transform transition-transform hover:scale-105';
                tagEl.textContent = `+ ${tagText}`;
                tagEl.onclick = (e) => { e.preventDefault(); if (!state.selectedInterests.includes(tagText)) { state.selectedInterests.push(tagText); renderTags(); } };
                ui.suggestedTagsContainer.appendChild(tagEl);
            });
        }
        
        ui.interestInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && ui.interestInput.value.trim() !== '') {
                e.preventDefault();
                const newTag = ui.interestInput.value.trim();
                if (!state.selectedInterests.includes(newTag)) { state.selectedInterests.push(newTag); renderTags(); }
                ui.interestInput.value = '';
            }
        });
        
        // --- Initialization ---
        flatpickr(ui.datePicker, { dateFormat: "Yå¹´mæœˆdæ—¥", locale: "zh_tw" });
        renderSuggestedTags();
        
        // --- Event Listeners ---
        ui.generateBtn.addEventListener('click', handleGenerate);
        ui.tabVisual.addEventListener('click', () => switchTab('visual'));
        ui.tabText.addEventListener('click', () => switchTab('text'));
        ui.tabMap.addEventListener('click', () => switchTab('map'));
        ui.copyBtn.addEventListener('click', copyTextToClipboard);
        ui.resetBtn.addEventListener('click', resetForm);
        ui.exportPdfBtn.addEventListener('click', handleExportPDF);

        function switchTab(tabName) {
            const tabs = { visual: ui.resultVisual, text: ui.resultText, map: ui.resultMap };
            const tabButtons = { visual: ui.tabVisual, text: ui.tabText, map: ui.tabMap };
            
            for (const key in tabs) {
                const isCurrent = key === tabName;
                tabs[key].classList.toggle('hidden', !isCurrent);
                tabButtons[key].className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg ${isCurrent ? 'text-cyan-600 border-cyan-600' : 'text-slate-500 hover:text-slate-700 hover:border-slate-300'}`;
            }
            
            if (tabName === 'map' && dailyLocations.length > 0 && ui.dayTogglesContainer.children.length > 0) {
                 const firstDayButton = ui.dayTogglesContainer.querySelector('button');
                 if(firstDayButton && !firstDayButton.classList.contains('day-toggle-btn-active')) {
                    firstDayButton.click();
                 }
                 setTimeout(() => {
                    if(map) google.maps.event.trigger(map, 'resize');
                 }, 100);
            }
        }

        function resetForm() {
            ui.resultWrapper.classList.add('hidden');
            ui.inputForm.classList.remove('hidden');
            ui.destination.value = '';
            ui.days.value = '';
            ui.datePicker._flatpickr.clear();
            state.selectedInterests = [];
            renderTags();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            dailyLocations = [];
            clearMap();
            ui.dayTogglesContainer.innerHTML = '';
        }
        
        function copyTextToClipboard() {
            if (!state.rawMarkdownContent) return;
            navigator.clipboard.writeText(state.rawMarkdownContent).then(() => {
                const originalText = ui.copyBtn.textContent;
                ui.copyBtn.textContent = 'å·²è¤‡è£½!';
                setTimeout(() => { ui.copyBtn.textContent = originalText; }, 2000);
            }).catch(err => {
                console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
            });
        }

        const icons = {
            description: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10.4 12.6a2 2 0 1 1 3 3L8 21l-4 1 1-4Z"/></svg>`,
            hours: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            transport: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><rect width="18" height="12" x="3" y="5" rx="2"/><path d="M3 11h18"/><path d="m8 17-2 4"/><path d="m18 17-2 4"/></svg>`,
            money: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            youtube: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 4.5 4 7 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2Z"/><path d="m10 9 5 3-5 3Z"/></svg>`,
            booking: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/><path d="M20 12v4H4v-4"/><path d="M20 8.5V4H4v4.5"/><path d="M16 4.5V2"/><path d="M8 4.5V2"/><path d="M4 12h16"/></svg>`,
            tip: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 2.69l.346.666L19.5 15.3l-1.846 3.199H6.346L4.5 15.3l7.154-11.934z"/><path d="M12 22v-3"/><path d="M8 22h8"/></svg>`,
            planB: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M22 12a10.06 10.06 0 0 0-2-5.85"/><path d="M3.5 14.29A9.95 9.95 0 0 0 2 18.5"/><path d="M22 18.5c0-1.79-1.09-4.39-2-5.85"/><path d="M2 12a10.06 10.06 0 0 1 2-5.85"/><path d="M12 2a10.06 10.06 0 0 1 5.85 2"/><path d="M12 22a10.06 10.06 0 0 0-5.85-2"/><path d="M18.35 14.29A9.95 9.95 0 0 1 22 18.5"/><path d="M5.65 9.71A9.95 9.95 0 0 1 2 5.5"/><path d="M5.65 14.29A9.95 9.95 0 0 0 2 18.5"/><path d="M18.35 9.71A9.95 9.95 0 0 0 22 5.5"/></svg>`,
        };
        
        // --- Visual Rendering (FIXED LOGIC) ---
        function renderVisualVersion(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const visualContent = document.createDocumentFragment();
            
            let currentNode = tempDiv.firstChild;
            while(currentNode && currentNode.tagName !== 'H2') {
                visualContent.appendChild(currentNode.cloneNode(true));
                currentNode = currentNode.nextElementSibling;
            }

            const daySections = tempDiv.querySelectorAll('h2');
            daySections.forEach((h2, dayIndex) => {
                visualContent.appendChild(h2.cloneNode(true));
                
                let element = h2.nextElementSibling;
                let itemIndex = 0; 
                
                while (element && element.tagName !== 'H2') {
                    if (element.tagName === 'UL' && (element.querySelector('li').textContent.includes('æœ¬æ—¥ä¸»é¡Œ') || element.querySelector('li').textContent.includes('é è¨ˆèŠ±è²»'))) {
                        visualContent.appendChild(createDaySummaryCard(element));
                    } 
                    else if (element.tagName === 'H3') {
                        visualContent.appendChild(element.cloneNode(true));
                    }
                    else if (element.tagName === 'UL' && element.querySelector('a[href*="google.com/maps/search"]')) {
                        const cardContainer = document.createElement('div');
                        cardContainer.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6';
                        
                        Array.from(element.children).forEach(li => {
                            const mainLink = li.querySelector('a');
                            if (mainLink && mainLink.parentElement === li && mainLink.href.startsWith('https://www.google.com/maps/search/')) {
                                const cardId = `card-${dayIndex}-${itemIndex}`;
                                cardContainer.appendChild(createLocationCard(li.innerHTML, cardId, dayIndex, itemIndex));
                                itemIndex++;
                            }
                        });
                        visualContent.appendChild(cardContainer);
                    }
                    element = element.nextElementSibling;
                }
            });

            ui.resultVisual.innerHTML = '';
            ui.resultVisual.appendChild(visualContent);
        }
        
        function createDaySummaryCard(ulElement) {
            const card = document.createElement('div');
            card.className = 'day-summary-card';
            const content = ulElement.innerHTML.replace(/<li>/g, '<div class="flex items-center gap-2 mb-1">').replace(/<\/li>/g, '</div>');
            card.innerHTML = content;
            return card;
        }
        
        function createLocationCard(liHTML, cardId, dayIndex, itemIndex) {
            const tempLi = document.createElement('li');
            tempLi.innerHTML = liHTML;

            const card = document.createElement('div');
            card.className = 'info-card';
            card.id = cardId;
            card.dataset.cardId = cardId;

            const mainLink = tempLi.querySelector('a');
            const locationName = mainLink.textContent.replace(/ğŸ“|ğŸœ|ï¿½/g, '').trim();
            
            const imageLink = document.createElement('a');
            // MODIFICATION: Use location name for the image link query to go directly to the venue page.
            imageLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName)}`;
            imageLink.target = '_blank';
            imageLink.rel = 'noopener noreferrer';
            imageLink.className = 'info-card-image-link';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'info-card-image-container';
            imageContainer.innerHTML = `<div class="animate-pulse bg-gray-300 w-full h-full"></div>`;
            imageLink.appendChild(imageContainer);
            
            const overlay = document.createElement('div');
            overlay.className = 'info-card-image-overlay';
            overlay.textContent = locationName;
            imageLink.appendChild(overlay);
            card.appendChild(imageLink);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'info-card-content';
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'info-card-details';
            
            const nestedUl = tempLi.querySelector('ul');
            if (nestedUl) {
                Array.from(nestedUl.children).forEach(nestedLi => {
                    const text = nestedLi.textContent || '';
                    const html = nestedLi.innerHTML;
                    let iconHtml = '', contentHtml = '';
                    
                    if (text.includes('ç°¡ä»‹')) { iconHtml = icons.description; contentHtml = html.replace(/.*?ç°¡ä»‹ï¼š/, ''); }
                    else if (text.includes('ç‡Ÿæ¥­æ™‚é–“')) { iconHtml = icons.hours; contentHtml = html.replace(/.*?ç‡Ÿæ¥­æ™‚é–“ï¼š/, ''); }
                    else if (text.includes('ç›¸é—œå½±ç‰‡')) { iconHtml = icons.youtube; contentHtml = html.replace(/.*?ç›¸é—œå½±ç‰‡ï¼š/, ''); }
                    else if (text.includes('èŠ±è²»')) { iconHtml = icons.money; contentHtml = html.replace(/.*?èŠ±è²»ï¼š/, ''); }
                    else if (text.includes('äº¤é€š')) { iconHtml = icons.transport; contentHtml = html.replace(/.*?äº¤é€šï¼š/, ''); }
                    else if (text.includes('é è¨‚')) { iconHtml = icons.booking; contentHtml = html.replace(/.*?é è¨‚\/è³¼ç¥¨ï¼š/, ''); }
                    else if (text.includes('å°ˆå®¶æç¤º')) { iconHtml = icons.tip; contentHtml = html.replace(/.*?å°ˆå®¶æç¤ºï¼š/, ''); }
                    else if (text.includes('é›¨å¤©å‚™æ¡ˆ')) { iconHtml = icons.planB; contentHtml = html.replace(/.*?é›¨å¤©å‚™æ¡ˆï¼š/, ''); }
                    else { contentHtml = html; }

                    if (iconHtml) {
                        const detailItem = document.createElement('div');
                        detailItem.className = 'detail-item';
                        detailItem.innerHTML = `${iconHtml}<div>${contentHtml.trim()}</div>`;
                        detailsDiv.appendChild(detailItem);
                    }
                });
            }
            contentDiv.appendChild(detailsDiv);

            const swapBtn = document.createElement('button');
            swapBtn.className = 'swap-button';
            swapBtn.innerHTML = `ğŸ”„ æ›ä¸€å€‹`;
            swapBtn.dataset.dayIndex = dayIndex;
            swapBtn.dataset.itemIndex = itemIndex;
            swapBtn.dataset.locationName = locationName;
            swapBtn.onclick = handleSwap;
            contentDiv.appendChild(swapBtn);
            
            card.appendChild(contentDiv);
            return card;
        }
        
        function findAndSetPhoto(locationName, imageContainer) {
             if (!placesService) {
                 console.warn("Places service not ready.");
                 return;
             }
            const request = {
                query: locationName,
                fields: ['photos'],
            };
            placesService.findPlaceFromQuery(request, (results, status) => {
                let photoUrl = `https://placehold.co/400x225/e2e8f0/94a3b8?text=${encodeURIComponent('ç„¡åœ–ç‰‡')}`;
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0 && results[0].photos) {
                    photoUrl = results[0].photos[0].getUrl({'maxWidth': 400, 'maxHeight': 400});
                } else {
                    console.warn(`Could not find photo for "${locationName}". Status: ${status}`);
                }
                const img = document.createElement('img');
                img.src = photoUrl;
                img.alt = `Photo of ${locationName}`;
                img.className = 'info-card-image';
                imageContainer.innerHTML = '';
                imageContainer.appendChild(img);
            });
        }
        
        async function handleSwap(event) {
            const button = event.currentTarget;
            const { dayIndex, itemIndex, locationName } = button.dataset;
            const cardId = `card-${dayIndex}-${itemIndex}`;
            const cardElement = document.getElementById(cardId);
            
            button.innerHTML = 'AI æ€è€ƒä¸­...';
            button.classList.add('loading');
            button.disabled = true;

            const swapPrompt = `
                è«‹æ ¹æ“šæˆ‘åŸæœ¬çš„æ—…éŠè¡Œç¨‹ï¼Œç‚ºæˆ‘æ›´æ›ä¸€å€‹åœ°é»ã€‚
                - **è¦æ›´æ›çš„åœ°é»**: "${locationName}"
                - **åŸæœ¬çš„è¡Œç¨‹æ¦‚è¦**: ${state.rawMarkdownContent.substring(0, 800)}...
                - **éœ€æ±‚**: è«‹æ¨è–¦ä¸€å€‹ä½æ–¼é™„è¿‘ã€é¡å‹ç›¸ä¼¼ä½†ä¸åŒçš„æ™¯é»æˆ–é¤å»³ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆã€‚
                - **è¼¸å‡ºæ ¼å¼**: **è«‹åªè¼¸å‡ºä¸€å€‹ Markdown çš„ç„¡åºåˆ—è¡¨é … (li)ï¼Œä¸”æ ¼å¼å¿…é ˆå’ŒåŸå§‹é …ç›®å®Œå…¨ä¸€æ¨£**ï¼ŒåŒ…å«åœ°åœ–é€£çµã€ç°¡ä»‹ã€ç›¸é—œå½±ç‰‡ã€ç‡Ÿæ¥­æ™‚é–“ã€èŠ±è²»å’Œäº¤é€šç­‰æ‰€æœ‰ç´°ç¯€ã€‚ä¸è¦è¼¸å‡ºä»»ä½•å…¶ä»–æ–‡å­—æˆ–è§£é‡‹ã€‚
            `;
            try {
                const apiKey = GEMINI_API_KEY; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: swapPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const newMarkdownLi = result.candidates[0].content.parts[0].text.trim();
                    
                    if (newMarkdownLi.startsWith('- ')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = marked.parse(newMarkdownLi);
                        const newLiHTML = tempDiv.querySelector('li').innerHTML;
                        
                        const newCard = createLocationCard(newLiHTML, cardId, dayIndex, itemIndex);
                        cardElement.replaceWith(newCard);
                        
                        const newLocationName = newCard.querySelector('.info-card-image-overlay').textContent;
                        const newImageContainer = newCard.querySelector('.info-card-image-container');
                        findAndSetPhoto(newLocationName, newImageContainer);

                        const newMainLink = tempDiv.querySelector('a');
                        const newQuery = new URL(newMainLink.href).searchParams.get('query');
                        dailyLocations[dayIndex].locations[itemIndex] = { name: newLocationName, query: newQuery, cardId: cardId };
                        
                        const currentDayToggle = ui.dayTogglesContainer.querySelector('.day-toggle-btn-active');
                        if (currentDayToggle && ui.dayTogglesContainer.children[dayIndex] === currentDayToggle) {
                            displayRouteForDay(dayIndex);
                        }

                    } else {
                        throw new Error("AI å›æ‡‰æ ¼å¼ä¸ç¬¦ï¼Œéåˆ—è¡¨é …ã€‚");
                    }
                } else {
                    throw new Error("AI æœªèƒ½æä¾›æœ‰æ•ˆå»ºè­°ã€‚");
                }

            } catch (error) {
                console.error("æ›´æ›å»ºè­°æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                button.innerHTML = 'æ›´æ›å¤±æ•—';
            } finally {
                 setTimeout(() => {
                    button.innerHTML = 'ğŸ”„ æ›ä¸€å€‹';
                    button.classList.remove('loading');
                    button.disabled = false;
                 }, 2000);
            }
        }
        
        function handleExportPDF() {
            const { jsPDF } = window.jspdf;
            const currentTab = document.querySelector('#result-wrapper nav button.text-cyan-600').id.replace('tab-', '');
            switchTab('visual');
            
            const resultContainer = document.getElementById('result-container');
            const originalBackgroundColor = resultContainer.style.backgroundColor;
            resultContainer.style.backgroundColor = 'white';

            html2canvas(resultContainer, {
                useCORS: true,
                scale: 2,
                onclone: (doc) => {
                    doc.querySelectorAll('.swap-button, .info-card.highlighted').forEach(el => {
                        if (el.classList.contains('swap-button')) el.style.display = 'none';
                        if (el.classList.contains('highlighted')) el.classList.remove('highlighted');
                    });
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const destination = ui.destination.value || 'my-trip';
                pdf.save(`${destination}-itinerary.pdf`);
            }).catch(err => {
                console.error("PDF export failed:", err);
                alert("æŠ±æ­‰ï¼ŒåŒ¯å‡º PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            }).finally(() => {
                resultContainer.style.backgroundColor = originalBackgroundColor;
                switchTab(currentTab);
            });
        }
        
        function parseItineraryForMap(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            dailyLocations = [];
            const daySections = tempDiv.querySelectorAll('h2');
            
            daySections.forEach((h2, dayIndex) => {
                const dayTitle = h2.textContent;
                const locationsForDay = [];
                let element = h2.nextElementSibling;
                let itemIndex = 0; 
                
                while (element && element.tagName !== 'H2') {
                     if (element.tagName === 'UL' && element.querySelector('a[href*="google.com/maps/search"]')) {
                         Array.from(element.children).forEach(li => {
                             const mainLink = li.querySelector('a');
                             if (mainLink && mainLink.parentElement === li && mainLink.href.includes('google.com/maps/search/')) {
                                 const name = mainLink.textContent.replace(/ğŸ“|ğŸœ|ï¿½/g, '').trim();
                                 const url = new URL(mainLink.href);
                                 const query = url.searchParams.get('query');
                                 if (name && query) {
                                     locationsForDay.push({ name: name, query: query, cardId: `card-${dayIndex}-${itemIndex++}` });
                                 }
                             }
                         });
                     }
                    element = element.nextElementSibling;
                }
                
                if (locationsForDay.length > 0) {
                    dailyLocations.push({ title: dayTitle, locations: locationsForDay });
                }
            });
            setupDayToggles();
        }

        function setupDayToggles() {
            ui.dayTogglesContainer.innerHTML = '';
            dailyLocations.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.textContent = day.title.split('ï¼š')[0];
                btn.className = 'day-toggle-btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all';
                btn.onclick = () => {
                    displayRouteForDay(index);
                    ui.dayTogglesContainer.querySelectorAll('button').forEach(b => b.classList.remove('day-toggle-btn-active'));
                    btn.classList.add('day-toggle-btn-active');
                };
                ui.dayTogglesContainer.appendChild(btn);
            });
        }

        function clearMap() {
            if (markers) markers.forEach(marker => marker.map = null);
            markers = [];
            if(directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            if (renderers) renderers.forEach(r => r.setMap(null));
            renderers = [];
            if (ui.mapDetailsContainer) ui.mapDetailsContainer.innerHTML = '';
        }
        
        async function displayRouteForDay(dayIndex) {
            clearMap();
            if (!dailyLocations[dayIndex] || dailyLocations[dayIndex].locations.length === 0) return;
        
            const dayData = dailyLocations[dayIndex];
            
            const placePromises = dayData.locations.map(loc => {
                const request = { query: loc.query, fields: ['name', 'geometry', 'place_id', 'photos'] };
                return new Promise(resolve => {
                    placesService.findPlaceFromQuery(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0].geometry) {
                            resolve({ ...loc, ...results[0], position: results[0].geometry.location });
                        } else {
                            console.warn(`Could not find place for "${loc.query}". Status: ${status}`);
                            resolve(null);
                        }
                    });
                });
            });

            const allGeocodedLocations = (await Promise.all(placePromises)).filter(Boolean);
            
            if (allGeocodedLocations.length === 0) {
                ui.mapDetailsContainer.innerHTML = '<p class="text-red-500">æŠ±æ­‰ï¼Œæ­¤å¤©çš„åœ°é»å‡ç„¡æ³•åœ¨åœ°åœ–ä¸Šå®šä½ã€‚</p>';
                return;
            }
            
            const bounds = new google.maps.LatLngBounds();
            const uniqueGeocodedLocations = [];
            const placeIdSet = new Set();

            allGeocodedLocations.forEach((loc, i) => {
                bounds.extend(loc.position);
                 const marker = new google.maps.marker.AdvancedMarkerElement({
                     position: loc.position, map, title: `${i + 1}. ${loc.name}`,
                     content: new google.maps.marker.PinElement({ glyph: `${i+1}`, scale: 1.2, background: '#0891b2', borderColor: '#ffffff', glyphColor: '#ffffff' }).element,
                 });
                 marker.addListener('click', () => highlightCardAndScroll(loc.cardId));
                 markers.push(marker);
                 
                 if (!placeIdSet.has(loc.place_id)) {
                    uniqueGeocodedLocations.push(loc);
                    placeIdSet.add(loc.place_id);
                 }
            });
            map.fitBounds(bounds);
        
            if (uniqueGeocodedLocations.length > 1) {
                const travelMode = ui.transport.value === 'ç§Ÿè»Šè‡ªé§•' ? google.maps.TravelMode.DRIVING : google.maps.TravelMode.TRANSIT;
                ui.mapDetailsContainer.innerHTML = '';

                if (travelMode === google.maps.TravelMode.DRIVING) {
                    const request = {
                        origin: uniqueGeocodedLocations[0].position, destination: uniqueGeocodedLocations[uniqueGeocodedLocations.length - 1].position,
                        waypoints: uniqueGeocodedLocations.slice(1, -1).map(loc => ({ location: loc.position, stopover: true })),
                        travelMode: travelMode
                    };
                    directionsService.route(request, (response, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(response);
                            renderMapDetails(response.routes[0].legs, uniqueGeocodedLocations, 0, travelMode);
                        } else {
                            console.error('Directions request failed due to ' + status);
                            ui.mapDetailsContainer.innerHTML = `<p class="text-red-500">ç„¡æ³•è¨ˆç®—é–‹è»Šè·¯ç·šè³‡è¨Šï¼š${status}</p>`;
                        }
                    });
                } else { // TRANSIT Mode with WALKING fallback
                    for (let i = 0; i < uniqueGeocodedLocations.length - 1; i++) {
                        const legRequest = {
                            origin: uniqueGeocodedLocations[i].position,
                            destination: uniqueGeocodedLocations[i + 1].position,
                            travelMode: google.maps.TravelMode.TRANSIT
                        };
                        
                        (function(index) {
                            directionsService.route(legRequest, (response, status) => {
                                if (status === google.maps.DirectionsStatus.OK) {
                                    const legRenderer = new google.maps.DirectionsRenderer({
                                        map: map, directions: response, suppressMarkers: true, preserveViewport: true,
                                        polylineOptions: { strokeColor: '#06b6d4', strokeWeight: 5, strokeOpacity: 0.7 }
                                    });
                                    renderers.push(legRenderer);
                                    renderMapDetails(response.routes[0].legs, [uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1]], index, google.maps.TravelMode.TRANSIT);
                                } else if (status === google.maps.DirectionsStatus.ZERO_RESULTS) {
                                    console.warn(`Transit for leg ${index} failed, falling back to WALKING.`);
                                    legRequest.travelMode = google.maps.TravelMode.WALKING;
                                    directionsService.route(legRequest, (walkResponse, walkStatus) => {
                                        if (walkStatus === google.maps.DirectionsStatus.OK) {
                                            const legRenderer = new google.maps.DirectionsRenderer({
                                                map: map, directions: walkResponse, suppressMarkers: true, preserveViewport: true,
                                                polylineOptions: { strokeColor: '#16a34a', strokeWeight: 6, strokeOpacity: 0.8, icons: [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 }, offset: '0', repeat: '20px'}] }
                                            });
                                            renderers.push(legRenderer);
                                            renderMapDetails(walkResponse.routes[0].legs, [uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1]], index, google.maps.TravelMode.WALKING);
                                        } else {
                                            console.error(`WALKING fallback for leg ${index} also failed: ${walkStatus}`);
                                            renderErrorLeg(uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1], index);
                                        }
                                    });
                                } else {
                                    console.error(`Transit directions for leg ${index} failed: ${status}`);
                                    renderErrorLeg(uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1], index);
                                }
                            });
                        })(i);
                    }
                }
            } else if (uniqueGeocodedLocations.length <= 1) {
                ui.mapDetailsContainer.innerHTML = '<p class="text-slate-500">æœ¬æ—¥åªæœ‰ä¸€å€‹åœ°é»æˆ–æ‰€æœ‰åœ°é»éƒ½åœ¨åŒä¸€è™•ï¼Œç„¡éœ€è¦åŠƒè·¯ç·šã€‚</p>';
            }
        }
        
        function renderMapDetails(legs, locations, startIndex, travelModeOverride) {
            legs.forEach((leg, i) => {
                const globalIndex = startIndex + i;
                const startLoc = locations[i];
                const endLoc = locations[i + 1];

                if (!startLoc || !endLoc) return;

                const detailLink = document.createElement('a');
                detailLink.className = 'map-leg-detail-link';
                detailLink.target = '_blank';
                detailLink.rel = 'noopener noreferrer';
                
                const mode = travelModeOverride ? travelModeOverride.toLowerCase() : (ui.transport.value === 'ç§Ÿè»Šè‡ªé§•' ? 'driving' : 'transit');
                const icon = mode === 'driving' ? 'ğŸš—' : (mode === 'walking' ? 'ğŸš¶' : 'ğŸš‡');
                
                // MODIFICATION: Use location names for the directions link for clarity.
                detailLink.href = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(startLoc.name)}&destination=${encodeURIComponent(endLoc.name)}&travelmode=${mode}`;

                const detailEl = document.createElement('div');
                detailEl.className = 'map-leg-detail';
                // MODIFICATION: Reworked the inner HTML for a cleaner route display.
                detailEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-center self-stretch">
                            <span class="bg-cyan-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm flex-shrink-0">${globalIndex + 1}</span>
                            <div class="h-full border-l-2 border-slate-300 border-dashed my-1"></div>
                            <span class="bg-cyan-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm flex-shrink-0">${globalIndex + 2}</span>
                        </div>
                        <div class="flex-grow py-1">
                             <p class="font-bold text-slate-800">${startLoc.name}</p>
                             <p class="text-sm text-slate-500 my-2">${icon} ç´„ ${leg.duration.text} (${leg.distance.text})</p>
                             <p class="font-bold text-slate-800">${endLoc.name}</p>
                        </div>
                    </div>
                `;
                detailLink.appendChild(detailEl);
                ui.mapDetailsContainer.appendChild(detailEl);
            });
        }
        
        function renderErrorLeg(startLoc, endLoc, index) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'map-leg-detail';
            errorDiv.innerHTML = `
                <p class="font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 1}</span>
                    <span>${startLoc.name}</span> <span class="text-slate-400">â†’</span>
                    <span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 2}</span>
                    <span>${endLoc.name}</span>
                </p>
                <p class="text-red-600 mt-1 pl-8">ç„¡æ³•è¦åŠƒæ­¤æ®µè·¯ç·šã€‚</p>`;
            ui.mapDetailsContainer.appendChild(errorDiv);
        }

        function highlightCardAndScroll(cardId) {
            if (ui.resultVisual.classList.contains('hidden')) {
                switchTab('visual');
            }
            document.querySelectorAll('.info-card').forEach(c => c.classList.remove('highlighted'));
            const cardElement = document.getElementById(cardId);
            if(cardElement) {
                cardElement.classList.add('highlighted');
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // --- Main Generation Logic ---
        async function handleGenerate() {
             if (!ui.destination.value || !ui.days.value || !ui.datePicker.value) {
                alert('è«‹å‹™å¿…å¡«å¯«ã€Œç›®çš„åœ°ã€ã€ã€Œç¸½å¤©æ•¸ã€å’Œã€Œå‡ºç™¼æ—¥æœŸã€ï¼');
                return;
             }
            ui.errorMessage.classList.add('hidden');
            ui.inputForm.classList.add('hidden');
            ui.loader.classList.remove('hidden');
            ui.resultWrapper.classList.add('hidden');
            ui.generateBtn.disabled = true;

            travelTipsInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * travelTips.length);
                ui.travelTip.textContent = travelTips[randomIndex];
            }, 2500);

            dailyLocations = [];
            clearMap();
            ui.dayTogglesContainer.innerHTML = '';
            
            let interestPrompt = state.selectedInterests.length > 0 ? `- **ä¸»è¦èˆˆè¶£ï¼š** ${state.selectedInterests.join('ã€')}` : '';

            const userPrompt = `
# è§’è‰²æ‰®æ¼”
ä½ æ˜¯ä¸€ä½æ“æœ‰20å¹´ç¶“é©—çš„é ‚å°–æ—…éŠè¦åŠƒå¸«ã€åœ¨åœ°åš®å°èˆ‡ç¾é£Ÿå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯çµåˆ Google åœ°åœ–ã€YouTubeã€ç¥¨å‹™å¹³å°èˆ‡åœ¨åœ°çŸ¥è­˜ï¼Œç‚ºä½¿ç”¨è€…ç”Ÿæˆä¸€ä»½**çµæ§‹æ¥µå…¶åš´è¬¹ã€è³‡è¨Šæ¥µåº¦è±å¯Œ**çš„ Markdown æ—…éŠè¡Œç¨‹ã€‚

# æˆ‘çš„æ—…éŠéœ€æ±‚
- **ç›®çš„åœ°ï¼š** ${ui.destination.value}
- **å¤©æ•¸ï¼š** ${ui.days.value}
- **æ—¥æœŸï¼š** ${ui.datePicker.value}
- **æ—…è¡Œè€…é¡å‹ï¼š** ${ui.travelerType.value}
- **æ—…è¡Œæ­¥èª¿ï¼š** ${ui.pacing.value} (ä½ æœƒæ ¹æ“šæ­¤èª¿æ•´æ¯æ—¥æ™¯é»æ•¸é‡)
- **é ç®—ç­‰ç´šï¼š** ${ui.budget.value} (ä½ æœƒæ ¹æ“šæ­¤æ¨è–¦å°æ‡‰åƒ¹ä½çš„é¤å»³èˆ‡æ´»å‹•)
- **ä¸»è¦äº¤é€šæ–¹å¼ï¼š** ${ui.transport.value} (ä½ æœƒæ ¹æ“šæ­¤æä¾›åœè»Šæˆ–å¤§çœ¾é‹è¼¸å»ºè­°)
${interestPrompt}

# è¼¸å‡ºæŒ‡ä»¤ (ä½ å¿…é ˆ100%åš´æ ¼éµå®ˆï¼Œå¦å‰‡çµæœç„¡æ³•è§£æ)
1.  **æ ¼å¼ï¼š** å¿…é ˆæ˜¯å®Œæ•´çš„ã€ç´”ç²¹çš„ Markdownã€‚çµ•ä¸åŒ…å«å…¶ä»–è¨»è§£æ–‡å­—ã€‚
2.  **æ—…ç¨‹ç¸½è¦½ï¼š** åœ¨æœ€å‰é¢ï¼Œç”Ÿæˆä¸€å€‹ H1 æ¨™é¡Œå’Œä¸€æ®µç°¡çŸ­çš„è¡Œç¨‹æ‘˜è¦ã€‚
3.  **æ¯æ—¥è¡Œç¨‹çµæ§‹ (æ¥µå…¶é‡è¦ï¼)ï¼š**
    -   **æ¯æ—¥æ¨™é¡Œ (H2):** ç‚ºæ¯ä¸€å¤©å»ºç«‹ H2 æ¨™é¡Œ (##)ï¼Œæ ¼å¼ç‚º \`## ç¬¬ä¸€å¤©ï¼šæœ¬æ—¥ä¸»é¡Œ\`ã€‚
    -   **æœ¬æ—¥ç¸½è¦½ (Daily Summary):** åœ¨ H2 ä¸‹æ–¹ï¼Œ**ç«‹åˆ»**å»ºç«‹ä¸€å€‹ç„¡åºåˆ—è¡¨ï¼Œ**å¿…é ˆ**åŒ…å«ä»¥ä¸‹å››é …ï¼š
        - \`* â˜€ï¸ æœ¬æ—¥ä¸»é¡Œï¼š[ç°¡çŸ­ä¸»é¡Œï¼Œä¾‹å¦‚ å¤è¹Ÿå·¡ç¦®]\`
        - \`* ğŸ’° é è¨ˆèŠ±è²»ï¼š[æ ¹æ“šé ç®—ç­‰ç´šä¼°ç®—ä¸€å€‹ç¯„åœï¼Œä¾‹å¦‚ ç´„ TWD 1,500 ~ 2,500 / äºº]\`
        - \`* ğŸƒ è¡Œç¨‹æ­¥èª¿ï¼š[å‘¼æ‡‰ä½¿ç”¨è€…é¸æ“‡çš„æ­¥èª¿]\`
        - \`* ğŸš— ä¸»è¦äº¤é€šï¼š[å‘¼æ‡‰ä½¿ç”¨è€…é¸æ“‡çš„äº¤é€šæ–¹å¼]\`
    -   **æ™‚æ®µæ¨™é¡Œ (H3):** ä¾åºå»ºç«‹ \`### ğŸŒ… ä¸Šåˆ\`, \`### â˜€ï¸ ä¸‹åˆ\`, \`### ğŸŒ™ æ™šä¸Š\`ã€‚åœ¨åˆé¤å’Œæ™šé¤æ™‚æ®µï¼Œ**å¿…é ˆ**åŠ å…¥ \`### ğŸœ ç”¨é¤\` æ¨™é¡Œã€‚
    -   **åœ°é»åˆ—è¡¨é … (li):** åœ¨æ¯å€‹ H3 ä¸‹æ–¹ï¼Œç”¨**ç„¡åºåˆ—è¡¨** (-) åˆ—å‡ºæ´»å‹•/é¤å»³ã€‚æ¯å€‹åˆ—è¡¨é …ä»£è¡¨ä¸€å€‹åœ°é»ã€‚
    -   **åœ°é»è©³ç´°è³‡è¨Š (å·¢ç‹€åˆ—è¡¨):**
        -   **ç¬¬ä¸€è¡Œ**å¿…é ˆæ˜¯è©²åœ°é»çš„ Google Maps æœå°‹é€£çµã€‚ç‚ºäº†åœ°åœ–ç²¾æº–ï¼Œé€£çµèˆ‡ query åƒæ•¸çš„åœ°é»åç¨±**å¿…é ˆæ˜¯ Google Maps ä¸Šçš„å…¨åæˆ–åœ°å€**ã€‚ç¯„ä¾‹ï¼š\`- [ğŸ“ å°åŒ—101è§€æ™¯å°](https://www.google.com/maps/search/?api=1&query=å°åŒ—101è§€æ™¯å°)\`
        -   æ›è¡Œå¾Œï¼Œä½¿ç”¨**å·¢ç‹€ç„¡åºåˆ—è¡¨**æä¾›è©³ç´°è³‡è¨Šï¼Œ**å¿…é ˆ**åŒ…å«ä»¥ä¸‹é …ç›® (è‹¥ä¸é©ç”¨å‰‡å¯«"ç„¡"æˆ–çœç•¥)ï¼Œé †åºä¸å¯éŒ¯ï¼š
            -   \`- ğŸŒŸ ç°¡ä»‹ï¼š[ç‚ºä½•æ¨è–¦æ­¤è™•çš„è©³ç´°åŸå› ]\`
            -   \`- ğŸ¬ ç›¸é—œå½±ç‰‡ï¼š[æä¾›ä¸€å€‹ YouTube **æœå°‹**é€£çµã€‚æ ¼å¼: [æœå°‹ã€Œåœ°é»ã€ä»‹ç´¹](https://www.youtube.com/results?search_query=URLç·¨ç¢¼çš„åœ°é»+ä»‹ç´¹)]\`
            -   \`- ç‡Ÿæ¥­æ™‚é–“ï¼š[æŸ¥è©¢ä¸¦å¡«å¯«ä¸€èˆ¬ç‡Ÿæ¥­æ™‚é–“]\`
            -   \`- ğŸ’° èŠ±è²»ï¼š[é ä¼°è²»ç”¨ç¯„åœ]\`
            -   \`- ğŸš— äº¤é€šï¼š[è‹¥é¸è‡ªé§•ï¼Œæç¤ºåœè»Šè³‡è¨Šã€‚è‹¥é¸å¤§çœ¾é‹è¼¸ï¼Œæä¾›è·¯ç·šå»ºè­°ã€‚]\`
            -   \`- ğŸŸï¸ é è¨‚/è³¼ç¥¨ï¼š[å¦‚æœé©ç”¨ï¼Œæä¾› Klook, KKday æˆ–é¤å»³è¨‚ä½ç³»çµ±çš„**å»ºè­°**é€£çµï¼Œæˆ–æç¤ºéœ€è¦æå‰é ç´„ã€‚æ ¼å¼: [åœ¨ Klook ä¸Šé è¨‚](https://www.klook.com/zh-TW/search/?query=åœ°é»)]\`
            -   \`- ğŸ’¡ å°ˆå®¶æç¤ºï¼š[æä¾›ä¸€å€‹å…§è¡Œäººæ‰çŸ¥é“çš„ç§˜è¨£æˆ–å»ºè­°]\`
            -   \`- â˜”ï¸ é›¨å¤©å‚™æ¡ˆï¼š[åƒ…å°**æˆ¶å¤–**æ™¯é»æä¾›ã€‚å»ºè­°ä¸€å€‹é™„è¿‘çš„å®¤å…§æ›¿ä»£æ–¹æ¡ˆã€‚]\`

# ç¯„ä¾‹è¼¸å‡ºç‰‡æ®µ (ä½ å¿…é ˆéµå¾ªæ­¤çµæ§‹):
## ç¬¬ä¸€å¤©ï¼šå¤éƒ½ä¹‹å¿ƒæ¼«éŠ
* â˜€ï¸ æœ¬æ—¥ä¸»é¡Œï¼šç¶“å…¸å¤è¹Ÿèˆ‡è€è¡—æ•£ç­–
* ğŸ’° é è¨ˆèŠ±è²»ï¼šç´„ JPY 4,000 ~ 6,000 / äºº
* ğŸƒ è¡Œç¨‹æ­¥èª¿ï¼šæ¨™æº–é©ä¸­
* ğŸš— ä¸»è¦äº¤é€šï¼šå¤§çœ¾é‹è¼¸
### ğŸŒ… ä¸Šåˆ
- [ğŸ“ æ¸…æ°´å¯º](https://www.google.com/maps/search/?api=1&query=äº¬éƒ½æ¸…æ°´å¯º)
    - ğŸŒŸ ç°¡ä»‹ï¼šäº¬éƒ½æœ€å¤è€çš„å¯ºé™¢ä¹‹ä¸€ï¼Œå¾æ¸…æ°´èˆå°ä¸Šå¯å°‡äº¬éƒ½å¸‚æ™¯ç›¡æ”¶çœ¼åº•ã€‚
    - ğŸ¬ ç›¸é—œå½±ç‰‡ï¼š[æœå°‹ã€Œæ¸…æ°´å¯ºã€ä»‹ç´¹](https://www.youtube.com/results?search_query=æ¸…æ°´å¯º+ä»‹ç´¹)
    - ç‡Ÿæ¥­æ™‚é–“ï¼š06:00 - 18:00
    - ğŸ’° èŠ±è²»ï¼šç´„ JPY 400 (é–€ç¥¨)
    - ğŸš— äº¤é€šï¼šå¾äº¬éƒ½è»Šç«™æ­ä¹˜å¸‚ç‡Ÿå·´å£«206è™Ÿç·šè‡³ã€Œäº”æ¡å‚ã€ç«™ä¸‹è»Šï¼Œæ­¥è¡Œç´„10åˆ†é˜ã€‚
    - ğŸŸï¸ é è¨‚/è³¼ç¥¨ï¼šé–€ç¥¨å¯ç¾å ´è³¼è²·ï¼Œç„¡éœ€é ç´„ã€‚
    - ğŸ’¡ å°ˆå®¶æç¤ºï¼šå»ºè­°æ—©ä¸Šä¸ƒé»å‰æŠµé”ï¼Œå¯ä»¥é¿é–‹æ—…è¡Œåœ˜äººæ½®ï¼Œäº«å—å¯§éœçš„æ°›åœã€‚
    - â˜”ï¸ é›¨å¤©å‚™æ¡ˆï¼šå¯å¢åŠ åœ¨å¯ºå…§åƒæ‹œåŠå•†åº—è¡—è³¼ç‰©æ™‚é–“ï¼Œæˆ–ææ—©å‰å¾€ä¸‹å€‹å®¤å…§è¡Œç¨‹ã€‚
`;
            try {
                const apiKey = GEMINI_API_KEY; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: userPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`API request failed, status: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    state.rawMarkdownContent = result.candidates[0].content.parts[0].text;
                    const htmlContent = marked.parse(state.rawMarkdownContent);
                    
                    ui.resultText.innerHTML = htmlContent;
                    renderVisualVersion(htmlContent);

                    const cards = ui.resultVisual.querySelectorAll('.info-card');
                    cards.forEach(card => {
                        const locationName = card.querySelector('.info-card-image-overlay').textContent;
                        const imageContainer = card.querySelector('.info-card-image-container');
                        findAndSetPhoto(locationName, imageContainer);
                    });

                    parseItineraryForMap(htmlContent);

                    ui.resultWrapper.classList.remove('hidden');
                    switchTab('visual');
                    ui.resultWrapper.scrollIntoView({ behavior: 'smooth' });
                } else {
                    let errorText = 'AI did not return a valid response.';
                    if(result.promptFeedback && result.promptFeedback.blockReason) {
                        errorText += ` Reason: ${result.promptFeedback.blockReason}`;
                    }
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error('Error generating itinerary:', error);
                ui.errorMessage.textContent = `å™¢ä¸ï¼è¦åŠƒæ™‚ç™¼ç”Ÿäº†é»å•é¡Œï¼š${error.message}ã€‚è«‹æª¢æŸ¥ API Keyã€ç¶²è·¯é€£ç·šæˆ–èª¿æ•´è¼¸å…¥å…§å®¹å¾Œå†è©¦ä¸€æ¬¡ã€‚`;
                ui.inputForm.classList.remove('hidden');
                ui.errorMessage.classList.remove('hidden');
            } finally {
                clearInterval(travelTipsInterval);
                ui.travelTip.textContent = '';
                ui.loader.classList.add('hidden');
                ui.generateBtn.disabled = false;
            }
        }
    });
    </script>
</body>
</html>
