<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 旅遊行程規劃師 v13.9.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✈️</text></svg>">
    <style>
        :root {
            --primary-color: #0891b2; /* Teal-600 */
            --primary-color-hover: #06b6d4; /* Cyan-500 */
            --secondary-bg: #f0f9ff; /* Sky-50 */
            --danger-color: #dc2626; /* Red-600 */
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--secondary-bg); 
            color: #334155; /* Slate-700 */
        }
        .form-input:focus, .flatpickr-input:focus { 
            --tw-ring-color: var(--primary-color-hover);
            border-color: var(--primary-color-hover);
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        .form-input.invalid {
            border-color: var(--danger-color);
            --tw-ring-color: var(--danger-color);
        }
        .form-input.invalid:focus {
             box-shadow: 0 0 0 2px var(--danger-color);
        }
        .main-title {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-color-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- 結果區域樣式 --- */
        #result-container h1 { font-size: 2.25rem; font-weight: bold; margin-bottom: 1rem; color: #1e293b; }
        #result-container h2 { font-size: 1.75rem; font-weight: bold; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; margin-top: 3rem; margin-bottom: 1.5rem; color: var(--primary-color); }
        #result-text h3, #result-visual h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; color: #334155; padding-left: 0.5rem; border-left: 4px solid var(--primary-color-hover); }

        .info-card {
            background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            overflow: hidden; margin-bottom: 1.5rem; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; position: relative;
        }
        .info-card:hover, .info-card.highlighted {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-color: var(--primary-color);
        }
        .info-card-image-link { display: block; position: relative; }
        .info-card-image-container { width: 100%; height: 180px; background-color: #e0f2fe; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .info-card-image { width: 100%; height: 100%; object-fit: cover; }
        .info-card-image-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 1.5rem 0.75rem 0.75rem; color: white; font-weight: bold; font-size: 1.1rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .info-card-content { padding: 1rem 1.25rem; flex-grow: 1; padding-bottom: 3.5rem; }
        .info-card-details { display: flex; flex-direction: column; gap: 0.75rem; color: #475569; }
        .info-card-details .detail-item { display: flex; align-items: flex-start; gap: 0.75rem; word-break: break-word; }
        .info-card-details .detail-icon { width: 20px; height: 20px; flex-shrink: 0; color: var(--primary-color); margin-top: 2px;}
        .info-card-details a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .info-card-details a:hover { text-decoration: underline; }
        
        .swap-button {
            position: absolute; bottom: 0.75rem; right: 1.25rem; background-color: var(--primary-color); color: white; border: none;
            border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s; display: flex; align-items: center; gap: 0.25rem;
        }
        .swap-button:hover { background-color: var(--primary-color-hover); }
        .swap-button.loading { cursor: not-allowed; background-color: #94a3b8; }
        
        .day-summary-card { background-color: #f0f9ff; border: 1px solid #bae6fd; border-left-width: 5px; border-left-color: var(--primary-color); padding: 1rem 1.5rem; margin-bottom: 2rem; border-radius: 0.5rem; }

        #map-container { width: 100%; height: 55vh; border-radius: 0.75rem; overflow: hidden; background-color: #e2e8f0; }
        .day-toggle-btn { transition: all 0.2s ease-in-out; }
        .day-toggle-btn-active { background-color: var(--primary-color) !important; color: white !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .map-leg-detail-link { display: block; text-decoration: none; }
        .map-leg-detail { background-color: #f8fafc; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; transition: background-color 0.2s; cursor: pointer; }
        .map-leg-detail-link:hover .map-leg-detail { background-color: #e0f2fe; }
        .map-leg-detail.highlighted { background-color: #e0f2fe; }
        
        /* UPDATED: Styles for suggested tags */
        #suggested-tags {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
        }
    </style>
    <!-- Google Maps API 腳本 (ADDED places library) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY&callback=initMap&libraries=marker,routes,geocoding,places"></script>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold main-title mb-3">AI 旅遊行程規劃師 v13.9.5</h1>
            <p class="text-lg text-slate-500">輸入您的旅遊靈感，即刻生成專業級視覺化行程與地圖路線</p>
        </div>
        
        <div id="form-validation-message" class="hidden max-w-4xl mx-auto mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-center"></div>

        <div id="input-form" class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <div>
                        <label for="destination" class="block text-md font-medium text-slate-700 mb-2">🌍 目的地</label>
                        <input type="text" id="destination" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="例如：日本京都、瑞士少女峰" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="days" class="block text-md font-medium text-slate-700 mb-2">⏳ 總天數</label>
                            <input type="number" id="days" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm" placeholder="例如：5" min="1" required>
                        </div>
                        <div>
                            <label for="date-picker" class="block text-md font-medium text-slate-700 mb-2">🗓️ 出發日期</label>
                            <input type="text" id="date-picker" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white" placeholder="選擇出發日期" required>
                        </div>
                    </div>
                    <div>
                        <label for="traveler-type" class="block text-md font-medium text-slate-700 mb-2">✈️ 旅行者類型</label>
                        <select id="traveler-type" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                            <option>情侶蜜月</option><option>親子家庭</option><option>獨自背包探險</option><option>三五好友輕旅行</option><option>退休樂活族</option><option>商務差旅</option>
                        </select>
                    </div>
                     <div>
                        <label for="transport" class="block text-md font-medium text-slate-700 mb-2">🚇 主要交通方式</label>
                        <select id="transport" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                            <option value="混合(大眾運輸為主)">混合(大眾運輸為主)</option>
                            <option value="租車自駕">租車自駕</option>
                        </select>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="space-y-6">
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pacing" class="block text-md font-medium text-slate-700 mb-2">🏃‍♂️ 旅行步調</label>
                            <select id="pacing" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="標準適中">標準適中 (預設)</option>
                                <option value="悠閒放鬆">悠閒放鬆</option>
                                <option value="緊湊充實">緊湊充實</option>
                            </select>
                        </div>
                        <div>
                            <label for="budget" class="block text-md font-medium text-slate-700 mb-2">💰 預算等級</label>
                            <select id="budget" class="form-input w-full p-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="平衡舒適">平衡舒適 (預設)</option>
                                <option value="經濟實惠">經濟實惠</option>
                                <option value="奢華享受">奢華享受</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-md font-medium text-slate-700">🎨 主要興趣偏好 (選填)</label>
                        <div id="interest-tags-container" class="flex flex-wrap gap-2 p-3 border border-slate-300 rounded-lg bg-slate-50 mt-2 min-h-[50px] items-center flex-grow">
                            <input type="text" id="interest-input" class="flex-grow bg-transparent focus:outline-none" placeholder="輸入後按 Enter 新增...">
                        </div>
                        <div id="suggested-tags" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="generate-btn" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center justify-center mx-auto gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L11.8 9.2a1.21 1.21 0 0 0 0 1.72l5.8 5.8a1.21 1.21 0 0 0 1.72 0l6.84-6.84a1.21 1.21 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-2"/><path d="M11 11 8 8"/><path d="M15 15l3 3"/><path d="m5 21 3-3"/></svg>
                    <span>生成靈感行程</span>
                </button>
            </div>
        </div>


        <div id="loader" class="hidden text-center my-10">
            <svg class="animate-spin h-12 w-12 text-cyan-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-slate-600 font-medium">AI 正在揮動魔法棒，為您客製化專屬行程...</p>
            <p id="travel-tip" class="mt-3 text-sm text-slate-500 h-5"></p>
        </div>
        
        <div id="error-message" class="hidden text-center my-10 max-w-2xl mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"></div>

        <div id="result-wrapper" class="hidden mt-10 max-w-7xl mx-auto">
             <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                  <div class="border-b border-slate-200"><nav class="-mb-px flex space-x-2 sm:space-x-6" aria-label="Tabs">
                        <button id="tab-visual" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">✨ 視覺化行程</button>
                        <button id="tab-text" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">📄 純文字版</button>
                        <button id="tab-map" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg">📍 地圖模式</button>
                  </nav></div>
                  <div class="flex items-center gap-2">
                        <button id="copy-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">複製文字</button>
                        <button id="export-pdf-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">匯出 PDF</button>
                        <button id="reset-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm sm:text-base">重新規劃</button>
                  </div>
             </div>
             <div id="result-container" class="bg-white p-4 sm:p-6 md:p-10 rounded-2xl shadow-xl">
                  <div id="result-visual"></div>
                  <div id="result-text" class="hidden prose max-w-none"></div>
                  <div id="result-map" class="hidden">
                        <div id="day-toggles-container" class="flex flex-wrap gap-2 mb-4"></div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="md:col-span-8 lg:col-span-9">
                                  <div id="map-container"></div>
                            </div>
                            <div class="md:col-span-4 lg:col-span-3 max-h-[55vh] overflow-y-auto pr-2">
                                  <div id="map-details-container" class="space-y-3"></div>
                            </div>
                        </div>
                  </div>
             </div>
        </div>
    </div>

    <script>
    // --- 全域變數 ---
    let map;
    let placesService;
    let directionsService;
    let directionsRenderer;
    let dailyLocations = []; 
    let markers = []; 
    let renderers = []; 
    let travelTipsInterval;

    // --- Google Maps 初始化 ---
    function initMap() {
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            console.error("Google Maps API script failed to load.");
            document.getElementById('error-message').textContent = '地圖服務載入失敗，請檢查您的網路連線或稍後再試。';
            document.getElementById('error-message').classList.remove('hidden');
            return;
        }
        const taipei = { lat: 25.0330, lng: 121.5654 };
        map = new google.maps.Map(document.getElementById("map-container"), {
            center: taipei,
            zoom: 12,
            mapId: 'DEMO_MAP_ID', 
            streetViewControl: false,
            mapTypeControl: false,
        });
        placesService = new google.maps.places.PlacesService(map);
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true, 
            polylineOptions: {
                strokeColor: '#0891b2', 
                strokeWeight: 6,
                strokeOpacity: 0.8
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- API KEYS ---
        // 警告：請勿將 API 金鑰直接寫在前端程式碼中。此處為範例。
        // 建議您使用後端服務或環境變數來安全地管理金鑰。
        const GEMINI_API_KEY = "AIzaSyC792BRnWglnao1MMUcc_M6DmO1cIZ4sd0"; // ！！！金鑰已更新

        // --- UI Elements ---
        const ui = {
            inputForm: document.getElementById('input-form'),
            generateBtn: document.getElementById('generate-btn'),
            loader: document.getElementById('loader'),
            travelTip: document.getElementById('travel-tip'),
            resultWrapper: document.getElementById('result-wrapper'),
            resultVisual: document.getElementById('result-visual'),
            resultText: document.getElementById('result-text'),
            resultMap: document.getElementById('result-map'),
            errorMessage: document.getElementById('error-message'),
            formValidationMessage: document.getElementById('form-validation-message'),
            tabVisual: document.getElementById('tab-visual'),
            tabText: document.getElementById('tab-text'),
            tabMap: document.getElementById('tab-map'),
            copyBtn: document.getElementById('copy-btn'),
            resetBtn: document.getElementById('reset-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            interestInput: document.getElementById('interest-input'),
            tagsContainer: document.getElementById('interest-tags-container'),
            suggestedTagsContainer: document.getElementById('suggested-tags'),
            dayTogglesContainer: document.getElementById('day-toggles-container'),
            mapDetailsContainer: document.getElementById('map-details-container'),
            destination: document.getElementById('destination'),
            days: document.getElementById('days'),
            datePicker: document.getElementById('date-picker'),
            travelerType: document.getElementById('traveler-type'),
            pacing: document.getElementById('pacing'),
            budget: document.getElementById('budget'),
            transport: document.getElementById('transport'),
        };
        
        let state = { selectedInterests: [], rawMarkdownContent: '' };
        const suggestedInterests = ['美食探索', '自然風光', '歷史古蹟', '購物血拼', '動漫文化', '夜生活體驗', '藝術展覽', '登山健行', '海灘戲水', '博物館參觀', '咖啡廳巡禮', '文創市集', '親子樂園', 'SPA按摩', '攝影旅拍', '溫泉放鬆'];
        const travelTips = [
            "小提示：下載 Google 翻譯的離線語言包，沒有網路也能溝通！", "小提示：日本大部分店家不接受議價喔！", "小提示：在歐洲，給服務生小費是對他們服務的肯定。", "小提示：出發前，用手機拍下護照和重要文件以防萬一。", "小提示：帶一個可重複使用的水瓶，環保又省錢。", "AI 正在為您尋找當地人才知道的秘境...", "AI 正在為您規劃最順暢的交通路線...", "AI 正在確認各個景點的營業時間..."
        ];

        // --- Tagging System ---
        function renderTags() {
            Array.from(ui.tagsContainer.children).forEach(child => child !== ui.interestInput && ui.tagsContainer.removeChild(child));
            state.selectedInterests.forEach(tagText => {
                const tagEl = document.createElement('span');
                tagEl.className = 'flex items-center bg-cyan-600 text-white text-sm font-medium pl-3 pr-2 py-1 rounded-full cursor-pointer';
                tagEl.textContent = tagText;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'ml-2 text-white/70 hover:text-white focus:outline-none';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    state.selectedInterests = state.selectedInterests.filter(t => t !== tagText);
                    renderTags();
                };
                tagEl.appendChild(removeBtn);
                ui.tagsContainer.insertBefore(tagEl, ui.interestInput);
            });
            ui.interestInput.focus();
        }

        function renderSuggestedTags() {
            ui.suggestedTagsContainer.innerHTML = ''; 
            suggestedInterests.forEach(tagText => {
                const tagEl = document.createElement('button');
                tagEl.className = 'bg-slate-200 text-slate-700 text-sm font-medium px-3 py-1.5 rounded-full hover:bg-slate-300 transform transition-transform hover:scale-105 text-center';
                tagEl.textContent = `+ ${tagText}`;
                tagEl.onclick = (e) => { e.preventDefault(); if (!state.selectedInterests.includes(tagText)) { state.selectedInterests.push(tagText); renderTags(); } };
                ui.suggestedTagsContainer.appendChild(tagEl);
            });
        }
        
        ui.interestInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && ui.interestInput.value.trim() !== '') {
                e.preventDefault();
                const newTag = ui.interestInput.value.trim();
                if (!state.selectedInterests.includes(newTag)) { state.selectedInterests.push(newTag); renderTags(); }
                ui.interestInput.value = '';
            }
        });
        
        // --- Initialization ---
        flatpickr(ui.datePicker, { dateFormat: "Y年m月d日", locale: "zh_tw" });
        renderSuggestedTags();
        
        // --- Event Listeners ---
        ui.generateBtn.addEventListener('click', handleGenerate);
        ui.tabVisual.addEventListener('click', () => switchTab('visual'));
        ui.tabText.addEventListener('click', () => switchTab('text'));
        ui.tabMap.addEventListener('click', () => switchTab('map'));
        ui.copyBtn.addEventListener('click', copyTextToClipboard);
        ui.resetBtn.addEventListener('click', resetForm);
        ui.exportPdfBtn.addEventListener('click', handleExportPDF);

        function switchTab(tabName) {
            const tabs = { visual: ui.resultVisual, text: ui.resultText, map: ui.resultMap };
            const tabButtons = { visual: ui.tabVisual, text: ui.tabText, map: ui.tabMap };
            
            for (const key in tabs) {
                const isCurrent = key === tabName;
                tabs[key].classList.toggle('hidden', !isCurrent);
                tabButtons[key].className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg ${isCurrent ? 'text-cyan-600 border-cyan-600' : 'text-slate-500 hover:text-slate-700 hover:border-slate-300'}`;
            }
            
            if (tabName === 'map' && dailyLocations.length > 0 && ui.dayTogglesContainer.children.length > 0) {
                 const firstDayButton = ui.dayTogglesContainer.querySelector('button');
                 if(firstDayButton && !firstDayButton.classList.contains('day-toggle-btn-active')) {
                   firstDayButton.click();
                 }
                 setTimeout(() => {
                     if(map) google.maps.event.trigger(map, 'resize');
                 }, 100);
            }
        }

        function resetForm() {
            ui.resultWrapper.classList.add('hidden');
            ui.inputForm.classList.remove('hidden');
            ui.destination.value = '';
            ui.days.value = '';
            ui.datePicker._flatpickr.clear();
            state.selectedInterests = [];
            renderTags();
            ui.formValidationMessage.classList.add('hidden');
            [ui.destination, ui.days, ui.datePicker].forEach(el => el.classList.remove('invalid'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
            dailyLocations = [];
            clearMap();
            ui.dayTogglesContainer.innerHTML = '';
        }
        
        function copyTextToClipboard() {
            if (!state.rawMarkdownContent) return;
            navigator.clipboard.writeText(state.rawMarkdownContent).then(() => {
                const originalText = ui.copyBtn.textContent;
                ui.copyBtn.textContent = '已複製!';
                setTimeout(() => { ui.copyBtn.textContent = originalText; }, 2000);
            }).catch(err => {
                console.error('無法複製文字: ', err);
                alert('複製失敗，您的瀏覽器可能不支援此功能。');
            });
        }

        const icons = {
            description: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10.4 12.6a2 2 0 1 1 3 3L8 21l-4 1 1-4Z"/></svg>`,
            hours: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            transport: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><rect width="18" height="12" x="3" y="5" rx="2"/><path d="M3 11h18"/><path d="m8 17-2 4"/><path d="m18 17-2 4"/></svg>`,
            money: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            youtube: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 4.5 4 7 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2Z"/><path d="m10 9 5 3-5 3Z"/></svg>`,
            booking: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/><path d="M20 12v4H4v-4"/><path d="M20 8.5V4H4v4.5"/><path d="M16 4.5V2"/><path d="M8 4.5V2"/><path d="M4 12h16"/></svg>`,
            tip: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M12 2.69l.346.666L19.5 15.3l-1.846 3.199H6.346L4.5 15.3l7.154-11.934z"/><path d="M12 22v-3"/><path d="M8 22h8"/></svg>`,
            planB: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M22 12a10.06 10.06 0 0 0-2-5.85"/><path d="M3.5 14.29A9.95 9.95 0 0 0 2 18.5"/><path d="M22 18.5c0-1.79-1.09-4.39-2-5.85"/><path d="M2 12a10.06 10.06 0 0 1 2-5.85"/><path d="M12 2a10.06 10.06 0 0 1 5.85 2"/><path d="M12 22a10.06 10.06 0 0 0-5.85-2"/><path d="M18.35 14.29A9.95 9.95 0 0 1 22 18.5"/><path d="M5.65 9.71A9.95 9.95 0 0 1 2 5.5"/><path d="M5.65 14.29A9.95 9.95 0 0 0 2 18.5"/><path d="M18.35 9.71A9.95 9.95 0 0 0 22 5.5"/></svg>`,
        };
        
        // --- Parsing and Rendering ---
        function parseAndRenderAll(htmlContent) {
            ui.resultText.innerHTML = htmlContent;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            const daySections = tempDiv.querySelectorAll('h2');
            const visualFragment = document.createDocumentFragment();
            
            // Render content before the first H2
            let firstH2 = tempDiv.querySelector('h2');
            if (firstH2) {
                let currentNode = tempDiv.firstChild;
                while (currentNode && currentNode !== firstH2) {
                    visualFragment.appendChild(currentNode.cloneNode(true));
                    currentNode = currentNode.nextSibling;
                }
            } else { // If no H2, render all content
                 visualFragment.appendChild(tempDiv.cloneNode(true));
            }


            dailyLocations = []; 

            daySections.forEach((h2, dayIndex) => {
                visualFragment.appendChild(h2.cloneNode(true));
                
                const locationsForDay = [];
                let itemIndex = 0;
                
                let element = h2.nextElementSibling;
                while (element && element.tagName !== 'H2') {
                    if (element.tagName === 'UL' && element.querySelector('li')?.textContent.includes('本日主題')) {
                        visualFragment.appendChild(createDaySummaryCard(element));
                    } else if (element.tagName === 'H3') {
                        visualFragment.appendChild(element.cloneNode(true));
                        
                        // Find the UL that follows the H3
                        let nextUl = element.nextElementSibling;
                        if (nextUl && nextUl.tagName === 'UL' && nextUl.querySelector('a[href*="google.com/maps/search"]')) {
                            const cardContainer = document.createElement('div');
                            cardContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
                            
                            Array.from(nextUl.children).forEach(li => {
                                // Find the first link in the li, which should be the map link
                                const mainLink = li.querySelector('a');
                                
                                if (mainLink && mainLink.href.includes('google.com/maps/search/')) {
                                    const cardId = `card-${dayIndex}-${itemIndex}`;
                                    const name = mainLink.textContent.replace(/📍|🍜|🍽️/g, '').trim();
                                    const query = new URL(mainLink.href).searchParams.get('query');
                                    
                                    if (name && query) {
                                        locationsForDay.push({ name: name, query: query, cardId: cardId });
                                        cardContainer.appendChild(createLocationCard(li.innerHTML, cardId, dayIndex, itemIndex));
                                        itemIndex++;
                                    }
                                }
                            });
                            visualFragment.appendChild(cardContainer);
                        }
                    }
                    element = element.nextElementSibling;
                }

                if (locationsForDay.length > 0) {
                    dailyLocations.push({ title: h2.textContent, locations: locationsForDay });
                }
            });

            ui.resultVisual.innerHTML = '';
            ui.resultVisual.appendChild(visualFragment);
            setupDayToggles();
        }

        function createDaySummaryCard(ulElement) {
            const card = document.createElement('div');
            card.className = 'day-summary-card';
            const content = ulElement.innerHTML.replace(/<li>/g, '<div class="flex items-center gap-2 mb-1">').replace(/<\/li>/g, '</div>');
            card.innerHTML = content;
            return card;
        }
        
        function createLocationCard(liHTML, cardId, dayIndex, itemIndex) {
            const tempLi = document.createElement('li');
            tempLi.innerHTML = liHTML;

            const card = document.createElement('div');
            card.className = 'info-card';
            card.id = cardId;
            card.dataset.cardId = cardId;

            const mainLink = tempLi.querySelector('a');
            const locationName = mainLink ? mainLink.textContent.replace(/📍|🍜|🍽️/g, '').trim() : '地點名稱未知';
            
            const imageLink = document.createElement('a');
            imageLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName)}`;
            imageLink.target = '_blank';
            imageLink.rel = 'noopener noreferrer';
            imageLink.className = 'info-card-image-link';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'info-card-image-container';
            imageContainer.innerHTML = `<div class="animate-pulse bg-gray-300 w-full h-full"></div>`;
            imageLink.appendChild(imageContainer);
            
            const overlay = document.createElement('div');
            overlay.className = 'info-card-image-overlay';
            overlay.textContent = locationName;
            imageLink.appendChild(overlay);
            card.appendChild(imageLink);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'info-card-content';
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'info-card-details';
            
            const nestedUl = tempLi.querySelector('ul');
            if (nestedUl) {
                Array.from(nestedUl.children).forEach(nestedLi => {
                    const text = nestedLi.textContent || '';
                    const html = nestedLi.innerHTML;
                    let iconHtml = '', contentHtml = '';
                    
                    if (text.includes('簡介')) { iconHtml = icons.description; contentHtml = html.replace(/.*?簡介：/, ''); }
                    else if (text.includes('營業時間')) { iconHtml = icons.hours; contentHtml = html.replace(/.*?營業時間：/, ''); }
                    else if (text.includes('相關影片')) { iconHtml = icons.youtube; contentHtml = html.replace(/.*?相關影片：/, ''); }
                    else if (text.includes('花費')) { iconHtml = icons.money; contentHtml = html.replace(/.*?花費：/, ''); }
                    else if (text.includes('交通')) { iconHtml = icons.transport; contentHtml = html.replace(/.*?交通：/, ''); }
                    else if (text.includes('預訂')) { iconHtml = icons.booking; contentHtml = html.replace(/.*?預訂\/購票：/, ''); }
                    else if (text.includes('專家提示')) { iconHtml = icons.tip; contentHtml = html.replace(/.*?專家提示：/, ''); }
                    else if (text.includes('雨天備案')) { iconHtml = icons.planB; contentHtml = html.replace(/.*?雨天備案：/, ''); }
                    else { contentHtml = html; }

                    if (iconHtml) {
                        const detailItem = document.createElement('div');
                        detailItem.className = 'detail-item';
                        detailItem.innerHTML = `${iconHtml}<div>${contentHtml.trim()}</div>`;
                        detailsDiv.appendChild(detailItem);
                    }
                });
            }
            contentDiv.appendChild(detailsDiv);

            const swapBtn = document.createElement('button');
            swapBtn.className = 'swap-button';
            swapBtn.innerHTML = `🔄 換一個`;
            swapBtn.dataset.dayIndex = dayIndex;
            swapBtn.dataset.itemIndex = itemIndex;
            swapBtn.dataset.locationName = locationName;
            swapBtn.onclick = handleSwap;
            contentDiv.appendChild(swapBtn);
            
            card.appendChild(contentDiv);
            return card;
        }
        
        function findAndSetPhoto(locationName, imageContainer) {
             if (!placesService) {
                 console.warn("Places service not ready.");
                 return;
             }
            const request = {
                query: locationName,
                fields: ['photos'],
            };
            placesService.findPlaceFromQuery(request, (results, status) => {
                let photoUrl = `https://placehold.co/400x225/e2e8f0/94a3b8?text=${encodeURIComponent('無圖片')}`;
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0 && results[0].photos) {
                    photoUrl = results[0].photos[0].getUrl({'maxWidth': 400, 'maxHeight': 400});
                } else {
                    console.warn(`Could not find photo for "${locationName}". Status: ${status}`);
                }
                const img = document.createElement('img');
                img.src = photoUrl;
                img.alt = `Photo of ${locationName}`;
                img.className = 'info-card-image';
                imageContainer.innerHTML = '';
                imageContainer.appendChild(img);
            });
        }
        
        async function handleSwap(event) {
            const button = event.currentTarget;
            const { dayIndex, itemIndex, locationName } = button.dataset;
            const cardId = `card-${dayIndex}-${itemIndex}`;
            const cardElement = document.getElementById(cardId);
            
            button.innerHTML = 'AI 思考中...';
            button.classList.add('loading');
            button.disabled = true;

            const swapPrompt = `
                請根據我原本的旅遊行程，為我更換一個地點。
                - **要更換的地點**: "${locationName}"
                - **原本的行程概要**: ${state.rawMarkdownContent.substring(0, 800)}...
                - **需求**: 請推薦一個位於附近、類型相似但不同的景點或餐廳作為替代方案。
                - **輸出格式**: **請只輸出一個 Markdown 的無序列表項 (li)，且格式必須和原始項目完全一樣**，包含地圖連結、簡介、相關影片、營業時間、花費和交通等所有細節。不要輸出任何其他文字或解釋。
            `;
            try {
                const apiKey = GEMINI_API_KEY; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: swapPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const newMarkdownLi = result.candidates[0].content.parts[0].text.trim();
                    
                    if (newMarkdownLi.startsWith('- ') || newMarkdownLi.startsWith('* ')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = marked.parse(newMarkdownLi);
                        const newLiHTML = tempDiv.querySelector('li').innerHTML;
                        
                        const newCard = createLocationCard(newLiHTML, cardId, dayIndex, itemIndex);
                        cardElement.replaceWith(newCard);
                        
                        const newLocationName = newCard.querySelector('.info-card-image-overlay').textContent;
                        const newImageContainer = newCard.querySelector('.info-card-image-container');
                        findAndSetPhoto(newLocationName, newImageContainer);

                        const newMainLink = tempDiv.querySelector('a');
                        const newQuery = new URL(newMainLink.href).searchParams.get('query');
                        dailyLocations[dayIndex].locations[itemIndex] = { name: newLocationName, query: newQuery, cardId: cardId };
                        
                        const currentDayToggle = ui.dayTogglesContainer.querySelector('.day-toggle-btn-active');
                        if (currentDayToggle && ui.dayTogglesContainer.children[dayIndex] === currentDayToggle) {
                            displayRouteForDay(dayIndex);
                        }

                    } else {
                        throw new Error("AI 回應格式不符，非列表項。");
                    }
                } else {
                    throw new Error("AI 未能提供有效建議。");
                }

            } catch (error) {
                console.error("更換建議時發生錯誤:", error);
                button.innerHTML = '更換失敗';
            } finally {
                 setTimeout(() => {
                     button.innerHTML = '🔄 換一個';
                     button.classList.remove('loading');
                     button.disabled = false;
                 }, 2000);
            }
        }
        
        function handleExportPDF() {
            const { jsPDF } = window.jspdf;
            const currentTab = document.querySelector('#result-wrapper nav button.text-cyan-600').id.replace('tab-', '');
            switchTab('visual');
            
            const resultContainer = document.getElementById('result-container');
            const originalBackgroundColor = resultContainer.style.backgroundColor;
            resultContainer.style.backgroundColor = 'white';

            html2canvas(resultContainer, {
                useCORS: true,
                scale: 2,
                onclone: (doc) => {
                    doc.querySelectorAll('.swap-button, .info-card.highlighted').forEach(el => {
                        if (el.classList.contains('swap-button')) el.style.display = 'none';
                        if (el.classList.contains('highlighted')) el.classList.remove('highlighted');
                    });
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const destination = ui.destination.value || 'my-trip';
                pdf.save(`${destination}-itinerary.pdf`);
            }).catch(err => {
                console.error("PDF export failed:", err);
                alert("抱歉，匯出 PDF 時發生錯誤。");
            }).finally(() => {
                resultContainer.style.backgroundColor = originalBackgroundColor;
                switchTab(currentTab);
            });
        }
        
        // --- Map Logic ---
        function setupDayToggles() {
            ui.dayTogglesContainer.innerHTML = '';
            dailyLocations.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.textContent = day.title.split('：')[0] || `第 ${index + 1} 天`;
                btn.className = 'day-toggle-btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all';
                btn.onclick = () => {
                    displayRouteForDay(index);
                    ui.dayTogglesContainer.querySelectorAll('button').forEach(b => b.classList.remove('day-toggle-btn-active'));
                    btn.classList.add('day-toggle-btn-active');
                };
                ui.dayTogglesContainer.appendChild(btn);
            });
        }

        function clearMap() {
            if (markers) markers.forEach(marker => marker.map = null);
            markers = [];
            if(directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            if (renderers) renderers.forEach(r => r.setMap(null));
            renderers = [];
            if (ui.mapDetailsContainer) ui.mapDetailsContainer.innerHTML = '';
        }
        
        async function displayRouteForDay(dayIndex) {
            clearMap();
            if (!dailyLocations[dayIndex] || dailyLocations[dayIndex].locations.length === 0) return;
        
            const dayData = dailyLocations[dayIndex];
            
            const placePromises = dayData.locations.map(loc => {
                const request = { query: loc.query, fields: ['name', 'geometry', 'place_id', 'photos'] };
                return new Promise(resolve => {
                    placesService.findPlaceFromQuery(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0].geometry) {
                            resolve({ ...loc, ...results[0], position: results[0].geometry.location });
                        } else {
                            console.warn(`Could not find place for "${loc.query}". Status: ${status}`);
                            resolve(null);
                        }
                    });
                });
            });

            const allGeocodedLocations = (await Promise.all(placePromises)).filter(Boolean);
            
            if (allGeocodedLocations.length === 0) {
                ui.mapDetailsContainer.innerHTML = '<p class="text-red-500">抱歉，此天的地點均無法在地圖上定位。</p>';
                return;
            }
            
            const bounds = new google.maps.LatLngBounds();
            const uniqueGeocodedLocations = [];
            const placeIdSet = new Set();

            allGeocodedLocations.forEach((loc, i) => {
                bounds.extend(loc.position);
                 const marker = new google.maps.marker.AdvancedMarkerElement({
                       position: loc.position, map, title: `${i + 1}. ${loc.name}`,
                       content: new google.maps.marker.PinElement({ glyph: `${i+1}`, scale: 1.2, background: '#0891b2', borderColor: '#ffffff', glyphColor: '#ffffff' }).element,
                 });
                 marker.addListener('click', () => highlightCardAndScroll(loc.cardId));
                 markers.push(marker);
                 
                 if (!placeIdSet.has(loc.place_id)) {
                     uniqueGeocodedLocations.push(loc);
                     placeIdSet.add(loc.place_id);
                 }
            });
            map.fitBounds(bounds);
        
            if (uniqueGeocodedLocations.length > 1) {
                const travelMode = ui.transport.value === '租車自駕' ? google.maps.TravelMode.DRIVING : google.maps.TravelMode.TRANSIT;
                ui.mapDetailsContainer.innerHTML = '';

                // Create placeholders for ordered rendering
                for (let i = 0; i < uniqueGeocodedLocations.length - 1; i++) {
                    const placeholder = document.createElement('div');
                    placeholder.id = `leg-placeholder-${i}`;
                    ui.mapDetailsContainer.appendChild(placeholder);
                }

                if (travelMode === google.maps.TravelMode.DRIVING) {
                    const request = {
                        origin: uniqueGeocodedLocations[0].position, destination: uniqueGeocodedLocations[uniqueGeocodedLocations.length - 1].position,
                        waypoints: uniqueGeocodedLocations.slice(1, -1).map(loc => ({ location: loc.position, stopover: true })),
                        travelMode: travelMode
                    };
                    directionsService.route(request, (response, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(response);
                            renderMapDetails(response.routes[0].legs, uniqueGeocodedLocations, travelMode);
                        } else {
                            console.error('Directions request failed due to ' + status);
                            ui.mapDetailsContainer.innerHTML = `<p class="text-red-500">無法計算開車路線資訊：${status}</p>`;
                        }
                    });
                } else { // TRANSIT Mode with WALKING fallback
                    for (let i = 0; i < uniqueGeocodedLocations.length - 1; i++) {
                        const legRequest = {
                            origin: uniqueGeocodedLocations[i].position,
                            destination: uniqueGeocodedLocations[i + 1].position,
                            travelMode: google.maps.TravelMode.TRANSIT
                        };
                        
                        (function(index) {
                            directionsService.route(legRequest, (response, status) => {
                                if (status === google.maps.DirectionsStatus.OK) {
                                    const legRenderer = new google.maps.DirectionsRenderer({
                                        map: map, directions: response, suppressMarkers: true, preserveViewport: true,
                                        polylineOptions: { strokeColor: '#06b6d4', strokeWeight: 5, strokeOpacity: 0.7 }
                                    });
                                    renderers.push(legRenderer);
                                    renderSingleMapDetail(response.routes[0].legs[0], uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1], index, google.maps.TravelMode.TRANSIT);
                                } else if (status === google.maps.DirectionsStatus.ZERO_RESULTS) {
                                    console.warn(`Transit for leg ${index} failed, falling back to WALKING.`);
                                    legRequest.travelMode = google.maps.TravelMode.WALKING;
                                    directionsService.route(legRequest, (walkResponse, walkStatus) => {
                                        if (walkStatus === google.maps.DirectionsStatus.OK) {
                                            const legRenderer = new google.maps.DirectionsRenderer({
                                                map: map, directions: walkResponse, suppressMarkers: true, preserveViewport: true,
                                                polylineOptions: { strokeColor: '#16a34a', strokeWeight: 6, strokeOpacity: 0.8, icons: [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 }, offset: '0', repeat: '20px'}] }
                                            });
                                            renderers.push(legRenderer);
                                            renderSingleMapDetail(walkResponse.routes[0].legs[0], uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1], index, google.maps.TravelMode.WALKING);
                                        } else {
                                            console.error(`WALKING fallback for leg ${index} also failed: ${walkStatus}`);
                                            renderErrorLeg(uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1], index);
                                        }
                                    });
                                } else {
                                    console.error(`Transit directions for leg ${index} failed: ${status}`);
                                    renderErrorLeg(uniqueGeocodedLocations[index], uniqueGeocodedLocations[index + 1], index);
                                }
                            });
                        })(i);
                    }
                }
            } else if (uniqueGeocodedLocations.length <= 1) {
                ui.mapDetailsContainer.innerHTML = '<p class="text-slate-500">本日只有一個地點或所有地點都在同一處，無需規劃路線。</p>';
            }
        }
        
        function renderMapDetails(legs, locations, travelMode) {
             legs.forEach((leg, i) => {
                 renderSingleMapDetail(leg, locations[i], locations[i+1], i, travelMode);
             });
        }
        
        function renderSingleMapDetail(leg, startLoc, endLoc, index, travelMode) {
            if (!startLoc || !endLoc) return;

            const placeholder = document.getElementById(`leg-placeholder-${index}`);
            if (!placeholder) return;

            const detailLink = document.createElement('a');
            detailLink.className = 'map-leg-detail-link';
            detailLink.target = '_blank';
            detailLink.rel = 'noopener noreferrer';
            
            const mode = travelMode.toLowerCase();
            const icon = mode === 'driving' ? '🚗' : (mode === 'walking' ? '🚶' : '🚇');
            
            detailLink.href = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(startLoc.name)}&destination=${encodeURIComponent(endLoc.name)}&travelmode=${mode}`;

            const detailEl = document.createElement('div');
            detailEl.className = 'map-leg-detail';
            detailEl.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex flex-col items-center self-stretch">
                        <span class="bg-cyan-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm flex-shrink-0">${index + 1}</span>
                        <div class="h-full border-l-2 border-slate-300 border-dashed my-1"></div>
                        <span class="bg-cyan-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm flex-shrink-0">${index + 2}</span>
                    </div>
                    <div class="flex-grow py-1">
                         <p class="font-bold text-slate-800">${startLoc.name}</p>
                         <p class="text-sm text-slate-500 my-2">${icon} 約 ${leg.duration.text} (${leg.distance.text})</p>
                         <p class="font-bold text-slate-800">${endLoc.name}</p>
                    </div>
                </div>
            `;
            detailLink.appendChild(detailEl);
            
            // Replace placeholder with the actual content
            placeholder.replaceWith(detailLink);
        }
        
        function renderErrorLeg(startLoc, endLoc, index) {
            const placeholder = document.getElementById(`leg-placeholder-${index}`);
            if (!placeholder) return;

            const errorDiv = document.createElement('div');
            errorDiv.className = 'map-leg-detail';
            errorDiv.innerHTML = `
                <p class="font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 1}</span>
                    <span>${startLoc.name}</span> <span class="text-slate-400">→</span>
                    <span class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 2}</span>
                    <span>${endLoc.name}</span>
                </p>
                <p class="text-red-600 mt-1 pl-8">無法規劃此段路線。</p>`;
            placeholder.replaceWith(errorDiv);
        }

        function highlightCardAndScroll(cardId) {
            if (ui.resultVisual.classList.contains('hidden')) {
                switchTab('visual');
            }
            document.querySelectorAll('.info-card').forEach(c => c.classList.remove('highlighted'));
            const cardElement = document.getElementById(cardId);
            if(cardElement) {
                cardElement.classList.add('highlighted');
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // --- Main Generation Logic ---
        function validateInputs() {
            const requiredFields = [
                { el: ui.destination, name: "目的地" },
                { el: ui.days, name: "總天數" },
                { el: ui.datePicker, name: "出發日期" }
            ];
            let missingFields = [];

            requiredFields.forEach(field => {
                if (!field.el.value.trim()) {
                    missingFields.push(field.name);
                    field.el.classList.add('invalid');
                } else {
                    field.el.classList.remove('invalid');
                }
            });

            if (missingFields.length > 0) {
                ui.formValidationMessage.textContent = `請填寫必要的欄位：${missingFields.join('、')}`;
                ui.formValidationMessage.classList.remove('hidden');
                return false;
            }
            
            ui.formValidationMessage.classList.add('hidden');
            return true;
        }

        async function handleGenerate() {
            if (!validateInputs()) {
                return;
            }

            ui.errorMessage.classList.add('hidden');
            ui.inputForm.classList.add('hidden');
            ui.loader.classList.remove('hidden');
            ui.resultWrapper.classList.add('hidden');
            ui.generateBtn.disabled = true;

            travelTipsInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * travelTips.length);
                ui.travelTip.textContent = travelTips[randomIndex];
            }, 2500);

            dailyLocations = [];
            clearMap();
            ui.dayTogglesContainer.innerHTML = '';
            
            let interestPrompt = state.selectedInterests.length > 0 ? `- **主要興趣：** ${state.selectedInterests.join('、')}` : '';

            // UPDATED PROMPT with new logic
            const userPrompt = `
# 角色扮演
你是一位擁有20年經驗的頂尖旅遊規劃師、在地嚮導與美食家。你的任務是結合 Google 地圖、YouTube、票務平台與在地知識，為使用者生成一份**結構極其嚴謹、資訊極度豐富**的 Markdown 旅遊行程。

# 我的旅遊需求
- **目的地：** ${ui.destination.value}
- **天數：** ${ui.days.value}
- **日期：** ${ui.datePicker.value}
- **旅行者類型：** ${ui.travelerType.value}
- **旅行步調：** ${ui.pacing.value}
- **預算等級：** ${ui.budget.value}
- **主要交通方式：** ${ui.transport.value}
${interestPrompt}

# 輸出指令 (你必須100%嚴格遵守，否則結果無法解析)
1.  **格式：** 必須是完整的、純粹的 Markdown。絕不包含其他註解文字。
2.  **旅程總覽：** 在最前面，生成一個 H1 標題和一段簡短的行程摘要。
3.  **行程密度規則 (***極度重要***)：你必須根據使用者選擇的「旅行步調」來決定每個時段(上午/下午/晚上)的活動數量：
    -   **如果步調是「悠閒放鬆」**：每個時段**必須**安排「1個景點 + 1個餐廳/咖啡廳」。
    -   **如果步調是「標準適中」**：每個時段**必須**安排至少2個活動，可以是「1個景點 + 1個餐廳」或「2個景點」。
    -   **如果步調是「緊湊充實」**：每個時段**必須**安排至少3個活動，例如「2個景點 + 1個餐廳」。
4.  **餐廳推薦邏輯 (***極度重要***)：
    -   推薦餐廳時，**絕對不准**說「XXX附近的餐廳」。
    -   你**必須**推薦**具體的餐廳名稱**。
    -   你**必須**優先選擇在 Google Maps 上擁有**大量評論且高評分**的知名店家。
5.  **每日行程結構 (嚴格遵守)：**
    -   **每日標題 (H2):** 為每一天建立 H2 標題 (##)，格式為 \`## 第一天：本日主題\`。
    -   **本日總覽 (Daily Summary):** 在 H2 下方，**立刻**建立一個無序列表，**必須**包含以下四項：
        - \`* ☀️ 本日主題：[簡短主題，例如 古蹟巡禮]\`
        - \`* 💰 預計花費：[根據預算等級估算一個範圍，例如 約 TWD 1,500 ~ 2,500 / 人]\`
        - \`* 🏃 行程步調：[呼應使用者選擇的步調]\`
        - \`* 🚗 主要交通：[呼應使用者選擇的交通方式]\`
    -   **時段標題 (H3):** 依序建立 \`### 🌅 上午\`, \`### ☀️ 下午\`, \`### 🌙 晚上\`。
    -   **地點列表項 (li):** 在每個 H3 下方，用**無序列表** (-) 列出景點與餐廳。午餐和晚餐的餐廳推薦，請直接放在對應的時段列表中，並用 🍜 或 🍽️ 表情符號標示。**不要**使用獨立的 \`### 🍜 用餐\` 標題。
    -   **地點詳細資訊 (巢狀列表):**
        -   **第一行**必須是該地點的 Google Maps 搜尋連結。為了地圖精準，連結與 query 參數的地點名稱**必須是 Google Maps 上的官方全名或地址**。範例：\`- [📍 台北101觀景台](https://www.google.com/maps/search/?api=1&query=台北101觀景台)\` 或 \`- [🍜 鼎泰豐 101店](https://www.google.com/maps/search/?api=1&query=鼎泰豐101店)\`
        -   換行後，使用**巢狀無序列表**提供詳細資訊，**必須**包含以下項目 (若不適用則寫"無"或省略)，順序不可錯：
            -   \`- 🌟 簡介：[為何推薦此處的詳細原因]\`
            -   \`- 🎬 相關影片：[提供一個 YouTube **搜尋**連結。格式: [搜尋「地點」介紹](https://www.youtube.com/results?search_query=URL編碼的地點+介紹)]\`
            -   \`- 營業時間：[查詢並填寫一般營業時間]\`
            -   \`- 💰 花費：[預估費用範圍]\`
            -   \`- 🚗 交通：[若選自駕，提示停車資訊。若選大眾運輸，提供路線建議。]\`
            -   \`- 🎟️ 預訂/購票：[如果適用，提供 Klook, KKday 或餐廳訂位系統的**建議**連結，或提示需要提前預約。格式: [在 Klook 上預訂](https://www.klook.com/zh-TW/search/?query=地點)]\`
            -   \`- 💡 專家提示：[提供一個內行人才知道的秘訣或建議]\`
            -   \`- ☔️ 雨天備案：[僅對**戶外**景點提供。建議一個附近的室內替代方案。]\`
`;
            try {
                const apiKey = GEMINI_API_KEY; 
                if (!apiKey) {
                    throw new Error("Gemini API Key is missing. 請在程式碼中填入您的金鑰。");
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: userPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(`API 請求失敗，狀態碼: ${response.status}. ${errorData.error?.message || ''}`);
                }
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    state.rawMarkdownContent = result.candidates[0].content.parts[0].text;
                    const htmlContent = marked.parse(state.rawMarkdownContent);
                    
                    parseAndRenderAll(htmlContent);

                    const cards = ui.resultVisual.querySelectorAll('.info-card');
                    cards.forEach(card => {
                        const locationName = card.querySelector('.info-card-image-overlay').textContent;
                        const imageContainer = card.querySelector('.info-card-image-container');
                        findAndSetPhoto(locationName, imageContainer);
                    });

                    ui.resultWrapper.classList.remove('hidden');
                    switchTab('visual');
                    ui.resultWrapper.scrollIntoView({ behavior: 'smooth' });
                } else {
                    let errorText = 'AI 未能回傳有效的行程內容。';
                    if(result.promptFeedback && result.promptFeedback.blockReason) {
                        errorText += ` 原因: ${result.promptFeedback.blockReason.toString()}`;
                    }
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error('Error generating itinerary:', error);
                ui.errorMessage.textContent = `噢不！規劃時發生了點問題：${error.message}。請檢查 API Key、網路連線或調整輸入內容後再試一次。`;
                ui.inputForm.classList.remove('hidden');
                ui.errorMessage.classList.remove('hidden');
            } finally {
                clearInterval(travelTipsInterval);
                ui.travelTip.textContent = '';
                ui.loader.classList.add('hidden');
                ui.generateBtn.disabled = false;
            }
        }
    });
    </script>
</body>
</html>
